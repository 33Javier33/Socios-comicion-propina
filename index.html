<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral - Fondo Solidario</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --purple: #9b59b6;
            --info: #17a2b8;
            --gastos: #607d8b;
            --pt-days: #34495e; /* Color para d√≠as PT */
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #444;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--text-color); }
        .container { max-width: 1100px; margin: 0 auto; padding-bottom: 80px; }

        /* Loader */
        #globalLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Navegaci√≥n */
        .nav-tabs { display: flex; margin-bottom: 25px; border-bottom: 2px solid #ddd; gap: 10px; overflow-x: auto; }
        .nav-btn { padding: 12px 20px; border: none; background: none; font-size: 1.05em; font-weight: 600; color: #7f8c8d; cursor: pointer; border-bottom: 4px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .nav-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); }
        .nav-btn:hover { color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        h1 { color: var(--primary); margin: 0; }
        .fecha-badge { background-color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }

        .smart-search { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.3s; box-sizing: border-box; }
        .smart-search:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }

        /* DASHBOARDS */
        .dashboard-socios { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .mini-stat { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid transparent; transition: transform 0.2s; position: relative; }
        
        .mini-stat.blue { border-bottom-color: var(--secondary); }
        .mini-stat.green { border-bottom-color: var(--success); }
        .mini-stat.orange { border-bottom-color: var(--warning); }
        .mini-stat.purple { border-bottom-color: var(--purple); }
        .mini-stat.red { border-bottom-color: var(--danger); }
        .mini-stat.dark { border-bottom-color: var(--pt-days); background-color: #f4f6f7; }

        .mini-stat.clickable { cursor: pointer; }
        .mini-stat.clickable:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; }

        .ms-val { display: block; font-size: 1.2em; font-weight: 800; color: var(--text-color); }
        .ms-label { font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: bold; margin-top: 5px; display: block;}

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 2100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); animation: fadeInModal 0.3s; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; animation: slideInModal 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes slideInModal { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 12px 12px 0 0; position: sticky; top: 0; z-index: 5; }
        .modal-body { padding: 25px; }
        .close-modal { font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .close-modal:hover { color: var(--danger); }

        /* Calendario Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .day-btn {
            padding: 10px; border: 2px solid #eee; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .day-btn:hover { border-color: var(--secondary); }
        .day-btn.selected { background-color: var(--secondary); color: white; border-color: var(--secondary); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .day-btn .d-date { font-weight: bold; display: block; margin-bottom: 4px; }
        .day-btn .d-val { font-size: 0.75em; opacity: 0.8; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: var(--primary); font-size: 0.9em; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .btn-submit, .btn-action { background-color: var(--secondary); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-submit:hover { background-color: #2980b9; }

        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--secondary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); cursor: pointer; transition: all 0.3s; z-index: 1000; border: none; }
        .fab-btn:hover { transform: scale(1.1); background-color: #2980b9; }

        .area-section { margin-bottom: 15px; }
        .area-header { display: flex; align-items: center; justify-content: space-between; background: white; padding: 15px 20px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s; user-select: none; }
        .area-header:hover { background-color: #f9f9f9; }
        .area-info { display: flex; align-items: center; gap: 15px; }
        .area-title { font-size: 1.1em; font-weight: bold; color: var(--primary); margin: 0; }
        .area-details { display: flex; gap: 10px; align-items: center; }
        .area-badge { background: #eee; color: #555; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .area-points { background: var(--primary); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .arrow-icon { transition: transform 0.3s ease; color: #999; font-size: 1.2em; }
        .area-header.active .arrow-icon { transform: rotate(180deg); }

        .cards-container { display: none; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-top: 15px; padding-left: 10px; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .border-left-mesas { border-left-color: #3498db; } .border-left-mesasPartTime { border-left-color: #3498db; }
        .border-left-cambistas { border-left-color: #9b59b6; }
        .border-left-maquinas { border-left-color: #e67e22; } .border-left-tecnicos { border-left-color: #7f8c8d; }
        .border-left-boveda { border-left-color: #27ae60; } .border-left-GastosComision { border-left-color: var(--gastos); }

        .socio-card { background-color: var(--card-bg); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 25px; position: relative; border-top: 5px solid var(--secondary); display: flex; flex-direction: column; }
        .area-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75em; padding: 4px 10px; border-radius: 20px; font-weight: bold; color: white; }
        .bg-mesas { background-color: #3498db; } .bg-mesasPartTime { background-color: #3498db; }
        .bg-cambistas { background-color: #9b59b6; }
        .bg-maquinas { background-color: #e67e22; } .bg-tecnicos { background-color: #7f8c8d; }
        .bg-boveda { background-color: #27ae60; } .bg-GastosComision { background-color: var(--gastos); }
        .border-mesas { border-top-color: #3498db; } .border-mesasPartTime { border-top-color: #3498db; }
        .border-cambistas { border-top-color: #9b59b6; }
        .border-maquinas { border-top-color: #e67e22; } .border-tecnicos { border-top-color: #7f8c8d; }
        .border-boveda { border-top-color: #27ae60; } .border-GastosComision { border-top-color: var(--gastos); }

        .card-header h3 { margin: 0; color: var(--primary); font-size: 1.2em; }
        .card-contract { font-size: 0.85em; color: #555; text-transform: uppercase; font-weight: bold; background-color: #f0f2f5; padding: 2px 8px; border-radius: 4px; }
        .card-body { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; }
        .points-badge { background: linear-gradient(135deg, var(--primary), #34495e); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .points-number { font-size: 1.2em; font-weight: 800; }
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-card { padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.9em; border: none; font-weight: 600; }
        .btn-edit { background-color: #fff; border: 1px solid var(--warning); color: var(--warning); }
        .btn-delete { background-color: #fff; border: 1px solid var(--danger); color: var(--danger); }

        .gestion-layout { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .search-panel { background: white; padding: 20px; border-radius: 12px; height: fit-content; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .search-results { margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .result-item:hover { background-color: #f9f9f9; padding-left: 15px; }
        .detail-panel { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: none; }
        .detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .action-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }
        
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        .history-table th { text-align: left; background: #eee; padding: 8px; }
        .history-table td { border-bottom: 1px solid #eee; padding: 8px; }
        .amount-minus { color: var(--danger); font-weight: bold; }
        .tag-absent { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary); display: flex; flex-direction: column; justify-content: center; }
        .stat-card.purple { border-left-color: var(--purple); }
        .stat-card.green { border-left-color: var(--success); }
        .stat-card.info { border-left-color: var(--info); background-color: #f0fbff; }
        .stat-label { font-size: 0.8em; color: #777; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .stat-value { font-size: 1.6em; font-weight: 800; color: var(--primary); }
        .stat-sub { font-size: 0.75em; color: #999; margin-top: 5px; }
        .date-card { background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; overflow: hidden; transition: all 0.3s; }
        .date-header { background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .date-title { font-size: 1.1em; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .date-divisor { background-color: #e8daef; color: #8e44ad; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .date-point-badge { background-color: var(--info); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; display: inline-block; }
        .date-total { font-size: 1.2em; font-weight: 800; color: var(--success); text-align: right; }
        .type-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); padding: 15px 20px; gap: 15px; }
        .type-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .type-name { font-size: 0.9em; color: #666; font-weight: 600; }
        .type-value { font-weight: bold; color: #333; }

        @media (max-width: 768px) { .gestion-layout { grid-template-columns: 1fr; } .action-grid { grid-template-columns: 1fr; } }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2500; }
        .toast { min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
    </style>
</head>
<body>

    <div id="globalLoader" style="display:none;">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold;" id="loaderText">Cargando...</p>
    </div>

    <div class="container">
        <div id="toast-container"></div>

        <div class="header-section">
            <h1>Sistema Integral <small style="font-size:0.5em; color:#777;">Fondo Solidario</small></h1>
            <div class="fecha-badge" id="fechaHoyBadge"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('registro')">Gesti√≥n de Socios</button>
            <button class="nav-btn" onclick="switchTab('gestion')">Anticipos y Ausencias</button>
            <button class="nav-btn" onclick="switchTab('recaudacion')">Montos Recaudados</button>
        </div>
        
        <!-- PESTA√ëA 1: REGISTRO DE SOCIOS -->
        <div id="tab-registro" class="tab-content active">
            
            <div class="dashboard-socios">
                <div class="mini-stat blue">
                    <span class="ms-val" id="totalSociosDash">0</span>
                    <span class="ms-label">Total Socios</span>
                </div>
                <div class="mini-stat green">
                    <span class="ms-val" id="totalPuntosDash">0</span>
                    <span class="ms-label">Total Puntos</span>
                </div>
                <div class="mini-stat orange">
                    <span class="ms-val" id="totalPlantaDash">0</span>
                    <span class="ms-label">S. Planta</span>
                </div>
                <div class="mini-stat purple">
                    <span class="ms-val" id="totalPartTimeDash">0</span>
                    <span class="ms-label">S. Part-Time</span>
                </div>
            </div>

            <input type="text" id="filtroRegistro" class="smart-search" placeholder="üîç Buscar socio por nombre, √°rea..." onkeyup="filtrarSociosRegistro()">

            <button class="fab-btn" onclick="abrirModalRegistro()">+</button>

            <div id="modalRegistro" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Nuevo Socio</h2>
                        <span class="close-modal" onclick="cerrarModalRegistro()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="registroForm">
                            <input type="hidden" id="editId">
                            <div class="form-grid">
                                <div class="form-group"><label>Nombre</label><input type="text" id="nombre" required placeholder="Ej: Juan"></div>
                                <div class="form-group"><label>Apellido</label><input type="text" id="apellido" required placeholder="Ej: P√©rez"></div>
                                <div class="form-group"><label>Fecha Ingreso</label><input type="date" id="fechaIngreso" required></div>
                                <div class="form-group">
                                    <label>√Årea</label>
                                    <select id="area" required>
                                        <option value="" disabled selected>Seleccionar...</option>
                                        <option value="mesas">Mesas</option>
                                        <option value="cambistas">Mesas - Cambistas</option>
                                        <option value="maquinas">M√°quinas</option>
                                        <option value="tecnicos">T√©cnicos</option>
                                        <option value="boveda">B√≥veda</option>
                                        <option value="GastosComision">GastosComision</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Contrato</label>
                                    <select id="contrato" required>
                                        <option value="" disabled selected>Seleccionar...</option>
                                        <option value="Planta">Planta</option>
                                        <option value="Part-Time">Part-Time</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:20px;">
                                <button type="submit" id="btnSubmit" class="btn-submit" style="width:100%;">Registrar Socio</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="mainSociosContainer"></div>
        </div>

        <!-- PESTA√ëA 2: GESTI√ìN (Anticipos) -->
        <div id="tab-gestion" class="tab-content">
            <div class="gestion-layout">
                <div class="search-panel">
                    <h3>Buscar Socio</h3>
                    <input type="text" id="buscadorGestion" placeholder="Escribe nombre o apellido..." onkeyup="filtrarSociosGestion()" style="width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <div id="listaResultados" class="search-results">
                        <div style="color:#999; font-style:italic; padding:10px;">Cargando lista...</div>
                    </div>
                </div>

                <div class="detail-panel" id="panelDetalle">
                    <input type="hidden" id="gestionSocioId">
                    <input type="hidden" id="gestionSocioNombre">
                    <input type="hidden" id="gestionSocioPuntos"> 
                    <input type="hidden" id="gestionSocioSaldoAnt" value="0"> 
                    
                    <div class="detail-header">
                        <div>
                            <h2 id="detNombre" style="margin:0; color:var(--primary);">Nombre Socio</h2>
                            <span id="detContrato" class="card-contract" style="font-size:1em; margin-top:5px;">PLANTA</span>
                            <div style="margin-top:5px; color:#666;" id="detArea">√Årea</div>
                        </div>
                        <div class="points-badge" style="width:70px; height:70px;">
                            <span id="detPuntos" class="points-number" style="font-size:1.6em;">0</span>
                            <span class="points-label">Pts</span>
                        </div>
                    </div>

                    <!-- ESTAD√çSTICAS FINANCIERAS PERSONALES -->
                    <div class="dashboard-socios" style="margin-bottom:20px;">
                        <div class="mini-stat orange clickable" onclick="abrirModalSaldo()" title="Clic para editar saldo inicial">
                            <span class="ms-val" id="socioSaldoAnterior">$0</span>
                            <span class="ms-label">Saldo Mes Ant. ‚úèÔ∏è</span>
                        </div>
                        
                        <!-- TARJETA DIAS TRABAJADOS (SOLO PART-TIME) -->
                        <div class="mini-stat dark clickable" id="cardDiasTrabajados" onclick="abrirModalCalendario()" style="display:none;" title="Clic para ver calendario">
                            <span class="ms-val" id="socioDiasCount">0</span>
                            <span class="ms-label">D√≠as Trab. üìÖ</span>
                        </div>

                        <div class="mini-stat blue">
                            <span class="ms-val" id="socioAlcance">$0</span>
                            <span class="ms-label">Alcance (Te√≥rico)</span>
                        </div>
                        <div class="mini-stat red">
                            <span class="ms-val" id="socioTotalPedido">$0</span>
                            <span class="ms-label">Total Pedido</span>
                        </div>
                        <div class="mini-stat green">
                            <span class="ms-val" id="socioSaldo">$0</span>
                            <span class="ms-label">Saldo a Recibir</span>
                        </div>
                    </div>

                    <div class="action-grid">
                        <div class="action-card">
                            <div class="action-title">üí∞ Anticipo de Propina</div>
                            <div class="form-group"><label>Monto ($)</label><input type="number" id="montoAnticipo" placeholder="Ej: 50000"></div>
                            <div class="form-group" style="margin-top:10px;"><label>Fecha</label><input type="date" id="fechaAnticipo"></div>
                            <button class="btn-action" style="width:100%; margin-top:15px;" onclick="enviarAnticipo()">Registrar Anticipo</button>
                        </div>
                        <div class="action-card" id="cardAusencias" style="display:none;">
                            <div class="action-title" style="color:var(--danger);">üìÖ Reportar Ausencia</div>
                            <div class="form-group"><label>Fecha Ausencia</label><input type="date" id="fechaAusencia"></div>
                            <div class="form-group" style="margin-top:10px;"><label>Motivo</label><input type="text" id="motivoAusencia" placeholder="Ej: Licencia, Falta..."></div>
                            <button class="btn-action" style="background-color:var(--danger); width:100%; margin-top:15px;" onclick="enviarAusencia()">Marcar Ausencia</button>
                        </div>
                    </div>

                    <h3 style="border-bottom:1px solid #ddd; padding-bottom:10px;">Historial</h3>
                    <table class="history-table">
                        <thead><tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Monto</th></tr></thead>
                        <tbody id="tablaHistorial"></tbody>
                    </table>
                </div>
                <div id="mensajeSeleccion" style="display:flex; justify-content:center; align-items:center; color:#999; height:300px; background:white; border-radius:12px;">Selecciona un socio para gestionar.</div>
            </div>
        </div>

        <!-- MODAL SALDO ANTERIOR -->
        <div id="modalSaldo" class="modal">
            <div class="modal-content" style="max-width:400px; margin-top:15%;">
                <div class="modal-header">
                    <h2>Saldo Mes Anterior</h2>
                    <span class="close-modal" onclick="cerrarModalSaldo()">&times;</span>
                </div>
                <div class="modal-body">
                    <p style="color:#666; font-size:0.9em; margin-bottom:15px;">Ingresa el monto sobrante o pendiente del mes pasado.</p>
                    <div class="form-group"><label>Monto ($)</label><input type="number" id="inputSaldoAnterior" placeholder="0"></div>
                    <div style="margin-top:20px;"><button class="btn-submit" onclick="guardarSaldoAnterior()" style="width:100%; background-color: var(--warning);">Guardar Saldo</button></div>
                </div>
            </div>
        </div>

        <!-- MODAL CALENDARIO PART-TIME -->
        <div id="modalCalendario" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>D√≠as Trabajados</h2>
                    <span class="close-modal" onclick="cerrarModalCalendario()">&times;</span>
                </div>
                <div class="modal-body">
                    <p style="color:#666; font-size:0.9em;">Selecciona los d√≠as que trabaj√≥ este socio. Solo aparecen d√≠as con recaudaci√≥n.</p>
                    <div id="calendarGrid" class="calendar-grid"></div>
                    <div style="margin-top:20px;">
                        <button class="btn-submit" onclick="guardarDiasTrabajados()">Guardar D√≠as</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA 3: RECAUDACIONES -->
        <div id="tab-recaudacion" class="tab-content">
            <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <input type="text" id="filtroRecaudacion" class="smart-search" placeholder="üìÖ Filtrar por fecha o monto..." onkeyup="filtrarRecaudacion()" style="width:60%; margin-bottom:0;">
                <button onclick="cargarRecaudaciones()" class="btn-action" style="background:#7f8c8d; width:auto; padding:8px 20px;">üîÑ Actualizar Datos</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card info">
                    <div class="stat-label">Total Puntos</div>
                    <div class="stat-value" id="recTotalPuntos">$0</div>
                    <div class="stat-sub">Suma de Puntos Noche</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Total Hist√≥rico</div>
                    <div class="stat-value" id="recGranTotal">$0</div>
                    <div class="stat-sub">Suma global recaudada</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Recaudaci√≥n √öltimo D√≠a</div>
                    <div class="stat-value" id="recTotalUltimoDia">$0</div>
                    <div class="stat-sub" id="recFechaUltimoDia">--/--/----</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">Divisor Actual</div>
                    <div class="stat-value" id="recDivisorActual">1.0</div>
                    <div class="stat-sub">Seg√∫n √∫ltimo registro</div>
                </div>
            </div>

            <hr style="border:0; border-top:1px solid #ddd; margin:30px 0;">
            <h3 style="color:var(--primary); margin-bottom:20px;">Historial Detallado por Fecha</h3>

            <div id="contenedorFechas">
                <div style="text-align:center; padding:40px; color:#999;">
                    Cargando historial detallado...
                </div>
            </div>
        </div>

    </div>

    <script>
        const URL_SOCIOS = "https://script.google.com/macros/s/AKfycbyr447pMQtsKoBfp8qTcB1uyE3rORhgPPmZM6Fgia3BgmIvtlZ_h04uGZrmx_HwubHQ/exec";
        const URL_RECAUDACIONES = "https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec"; 

        let cacheSocios = [];
        let isEditing = false;
        let globalValorPuntoTotal = 0;
        let globalMapaPuntosDia = {}; // Para saber cu√°nto vale el punto cada d√≠a
        let selectedDaysPT = []; // D√≠as seleccionados temporalmente en el modal

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date();
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('fechaHoyBadge').textContent = hoy.toLocaleDateString('es-ES', opciones);
            
            const todayISO = hoy.toISOString().split('T')[0];
            document.getElementById('fechaAnticipo').value = todayISO;
            document.getElementById('fechaAusencia').value = todayISO;

            if(!URL_SOCIOS || URL_SOCIOS.includes("PEGA_AQUI")) {
                alert("‚ö†Ô∏è Falta configurar URL_SOCIOS");
            } else {
                fetchSociosDeGoogle();
                cargarRecaudaciones(true); 
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            if(tabName === 'registro') btns[0].classList.add('active');
            else if(tabName === 'gestion') { btns[1].classList.add('active'); renderizarListaBusqueda(); }
            else if(tabName === 'recaudacion') { btns[2].classList.add('active'); cargarRecaudaciones(); }
        }

        // --- MODALES ---
        function abrirModalRegistro() { document.getElementById('modalRegistro').style.display = 'block'; if(!isEditing) { document.getElementById('registroForm').reset(); document.getElementById('editId').value = ''; document.getElementById('modalTitle').innerText = 'Nuevo Socio'; document.getElementById('btnSubmit').innerText = 'Registrar Socio'; } }
        function cerrarModalRegistro() { document.getElementById('modalRegistro').style.display = 'none'; isEditing = false; document.getElementById('registroForm').reset(); document.getElementById('editId').value = ''; }
        
        function abrirModalSaldo() { document.getElementById('modalSaldo').style.display = 'block'; const valActual = document.getElementById('gestionSocioSaldoAnt').value; document.getElementById('inputSaldoAnterior').value = valActual; }
        function cerrarModalSaldo() { document.getElementById('modalSaldo').style.display = 'none'; }
        
        // --- MODAL CALENDARIO ---
        function abrirModalCalendario() {
            document.getElementById('modalCalendario').style.display = 'block';
            renderCalendarGrid();
        }
        function cerrarModalCalendario() { document.getElementById('modalCalendario').style.display = 'none'; }

        function renderCalendarGrid() {
            const container = document.getElementById('calendarGrid');
            container.innerHTML = '';
            
            // Obtener fechas disponibles ordenadas
            const fechas = Object.keys(globalMapaPuntosDia).sort().reverse();
            
            fechas.forEach(fecha => {
                const div = document.createElement('div');
                div.className = 'day-btn';
                if(selectedDaysPT.includes(fecha)) div.classList.add('selected');
                
                const partes = fecha.split('-');
                const fechaVisual = `${partes[2]}/${partes[1]}`;
                const valorPunto = globalMapaPuntosDia[fecha];

                div.innerHTML = `<span class="d-date">${fechaVisual}</span><span class="d-val">$${Math.round(valorPunto)}</span>`;
                div.onclick = () => toggleDaySelection(div, fecha);
                container.appendChild(div);
            });
        }

        function toggleDaySelection(el, fecha) {
            if(selectedDaysPT.includes(fecha)) {
                selectedDaysPT = selectedDaysPT.filter(d => d !== fecha);
                el.classList.remove('selected');
            } else {
                selectedDaysPT.push(fecha);
                el.classList.add('selected');
            }
        }

        async function guardarDiasTrabajados() {
            const id = document.getElementById('gestionSocioId').value;
            const nombre = document.getElementById('gestionSocioNombre').value;
            toggleLoader(true, "Guardando d√≠as...");
            try {
                await callApiSocios('guardarDiasPartTime', { id, nombre, dias: selectedDaysPT });
                showToast('D√≠as actualizados', 'success');
                cerrarModalCalendario();
                cargarHistorialSocio(id); // Recalcular todo
            } catch(e) {
                showToast('Error guardando', 'error');
            } finally { toggleLoader(false); }
        }

        async function guardarSaldoAnterior() {
            const nuevoSaldo = parseFloat(document.getElementById('inputSaldoAnterior').value) || 0;
            const idSocio = document.getElementById('gestionSocioId').value;
            const nombreSocio = document.getElementById('gestionSocioNombre').value;
            toggleLoader(true, "Guardando Saldo...");
            try {
                await callApiSocios('registrarSaldoAnterior', { id: idSocio, nombre: nombreSocio, monto: nuevoSaldo });
                showToast('Saldo actualizado', 'success');
                document.getElementById('gestionSocioSaldoAnt').value = nuevoSaldo;
                cerrarModalSaldo();
                cargarHistorialSocio(idSocio);
            } catch(e) { showToast('Error al guardar saldo', 'error'); } finally { toggleLoader(false); }
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modalRegistro')) cerrarModalRegistro();
            if (event.target == document.getElementById('modalSaldo')) cerrarModalSaldo();
            if (event.target == document.getElementById('modalCalendario')) cerrarModalCalendario();
        }

        // =======================================================
        // L√ìGICA DE SOCIOS
        // =======================================================
        function toggleLoader(show, text="Cargando...") {
            const l = document.getElementById('globalLoader');
            document.getElementById('loaderText').innerText = text;
            l.style.display = show ? 'flex' : 'none';
        }

        async function callApiSocios(action, payload = null) {
            if (!payload) {
                const response = await fetch(`${URL_SOCIOS}?action=${action}`);
                return await response.json();
            }
            const opts = { 
                method: 'POST', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action, ...payload }) 
            };
            const response = await fetch(URL_SOCIOS, opts);
            return await response.json();
        }

        async function fetchSociosDeGoogle() {
            toggleLoader(true, "Obteniendo datos...");
            try {
                const res = await callApiSocios('getSocios');
                if (res.status === 'success') {
                    cacheSocios = res.data.map(procesarSocioDesdeGoogle);
                    renderizarCards();
                } else { showToast('Error: ' + res.message, 'error'); }
            } catch (e) { console.error(e); showToast('Error de conexi√≥n', 'error'); } finally { toggleLoader(false); }
        }

        function procesarSocioDesdeGoogle(s) {
            const fechaStr = s.FechaIngreso; 
            if(!fechaStr) return { ...s, anios: 0, puntos: 0 };
            const partes = fechaStr.split('-');
            const fechaIngreso = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
            const fechaActual = new Date();
            let anios = fechaActual.getFullYear() - fechaIngreso.getFullYear();
            if (fechaActual.getMonth() < fechaIngreso.getMonth() || (fechaActual.getMonth() === fechaIngreso.getMonth() && fechaActual.getDate() < fechaIngreso.getDate())) { anios--; }
            if (anios < 0) anios = 0;
            const areaNorm = (s.Area || "").toLowerCase().trim();
            if (areaNorm === 'gastoscomision' || areaNorm.includes('gastos')) {
                return { id: s.ID, nombre: s.Nombre, apellido: s.Apellido, area: 'GastosComision', contrato: s.TipoContrato, fechaIngreso: fechaStr, anios: anios, puntos: 1 };
            }
            let puntosMaximos = 10;
            if (areaNorm === 'mesas') puntosMaximos = 20;
            else if (areaNorm === 'maquinas') puntosMaximos = 12;
            else if (areaNorm === 'tecnicos') puntosMaximos = 12;
            else if (areaNorm === 'boveda') puntosMaximos = 10;
            else if (areaNorm.includes('cambista')) puntosMaximos = 8;
            const puntosBase = 4;
            let puntosCalculados = puntosBase + (anios * 2);
            let puntosFinales = (puntosCalculados > puntosMaximos) ? puntosMaximos : puntosCalculados;
            return { id: s.ID, nombre: s.Nombre, apellido: s.Apellido, area: areaNorm, contrato: s.TipoContrato, fechaIngreso: fechaStr, anios: anios, puntos: puntosFinales };
        }

        document.getElementById('registroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const d = { Nombre: document.getElementById('nombre').value, Apellido: document.getElementById('apellido').value, FechaIngreso: document.getElementById('fechaIngreso').value, Area: document.getElementById('area').value, TipoContrato: document.getElementById('contrato').value };
            const idEdit = document.getElementById('editId').value;
            toggleLoader(true, isEditing ? "Actualizando..." : "Guardando...");
            try {
                if (isEditing) { await callApiSocios('updateSocio', { socioId: idEdit, updates: d }); showToast('Socio actualizado', 'success'); } 
                else { await callApiSocios('addSocio', { socio: d }); showToast('Socio registrado', 'success'); }
                cerrarModalRegistro(); fetchSociosDeGoogle(); 
            } catch (e) { showToast('Error al guardar', 'error'); } finally { toggleLoader(false); }
        });

        function renderizarCards() {
            const container = document.getElementById('mainSociosContainer');
            container.innerHTML = '';
            let totalSocios = cacheSocios.length;
            let totalPuntos = cacheSocios.reduce((a,b) => a + b.puntos, 0);
            let totalPlanta = cacheSocios.filter(s => s.contrato === 'Planta').length;
            let totalPart = cacheSocios.filter(s => s.contrato === 'Part-Time').length;
            document.getElementById('totalSociosDash').innerText = totalSocios;
            document.getElementById('totalPuntosDash').innerText = totalPuntos;
            document.getElementById('totalPlantaDash').innerText = totalPlanta;
            document.getElementById('totalPartTimeDash').innerText = totalPart;

            if(cacheSocios.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">No hay datos de socios.</div>'; return; }
            
            const grupos = { 'mesas': [], 'mesasPartTime': [], 'cambistas': [], 'maquinas': [], 'tecnicos': [], 'boveda': [], 'GastosComision': [] };
            const nombresArea = { 'mesas': 'Mesas (Planta)', 'mesasPartTime': 'Mesas (Part-Time)', 'cambistas': 'Mesas (Cambistas)', 'maquinas': 'M√°quinas', 'tecnicos': 'T√©cnicos', 'boveda': 'B√≥veda', 'GastosComision': 'Gastos Comisi√≥n' };

            cacheSocios.forEach(socio => {
                let key = socio.area.toLowerCase().replace(/\s/g, '');
                if (key.includes('cambista')) key = 'cambistas'; else if (key.includes('gastos')) key = 'GastosComision';
                if (key === 'mesas') { if (socio.contrato === 'Part-Time') key = 'mesasPartTime'; else key = 'mesas'; }
                if (grupos[key]) grupos[key].push(socio); else { if(!grupos['otros']) grupos['otros'] = []; grupos['otros'].push(socio); nombresArea['otros'] = 'Otros / Sin Clasificar'; }
            });

            for (const [key, listaSocios] of Object.entries(grupos)) {
                if (!listaSocios || listaSocios.length === 0) continue;
                listaSocios.sort((a,b) => a.nombre.localeCompare(b.nombre));
                const totalPuntosArea = listaSocios.reduce((acc, s) => acc + s.puntos, 0);
                const section = document.createElement('div');
                section.className = 'area-section';
                section.setAttribute('data-area-id', key);
                const header = document.createElement('div');
                header.className = `area-header border-left-${key}`;
                header.onclick = function() { toggleArea(key); };
                header.innerHTML = `<div class="area-info"><span class="arrow-icon" id="icon-${key}">‚ñº</span><div class="area-title">${nombresArea[key] || key.toUpperCase()}</div></div><div class="area-details"><span class="area-badge">${listaSocios.length} Soc.</span><span class="area-points">Pts: ${totalPuntosArea}</span></div>`;
                section.appendChild(header);
                const grid = document.createElement('div');
                grid.className = 'cards-container';
                grid.id = `container-${key}`;
                listaSocios.forEach(socio => {
                    const card = document.createElement('div');
                    card.className = `socio-card border-${key}`;
                    card.setAttribute('data-search-name', `${socio.nombre} ${socio.apellido} ${socio.area}`.toLowerCase());
                    const f = socio.fechaIngreso.split('-');
                    const fechaVis = `${f[2]}/${f[1]}/${f[0]}`;
                    card.innerHTML = `<div class="area-tag bg-${key}">${nombresArea[key] || socio.area}</div><div class="card-header"><h3>${socio.nombre} ${socio.apellido}</h3><span class="card-contract">${socio.contrato}</span></div><div class="card-body"><div><p style="margin:0; font-size:0.9em;">Antig√ºedad: ${socio.anios} a√±os</p><small style="color:#999;">${fechaVis}</small></div><div class="points-badge"><span class="points-number">${socio.puntos}</span></div></div><div class="card-actions"><button class="btn-card btn-edit" onclick="prepararEdicion('${socio.id}')">Editar</button><button class="btn-card btn-delete" onclick="eliminarSocio('${socio.id}')">Eliminar</button></div>`;
                    grid.appendChild(card);
                });
                section.appendChild(grid);
                container.appendChild(section);
            }
        }

        function toggleArea(key) {
            const container = document.getElementById(`container-${key}`);
            const icon = document.getElementById(`icon-${key}`);
            const header = icon.closest('.area-header');
            if (container.style.display === 'grid') { container.style.display = 'none'; header.classList.remove('active'); icon.style.transform = 'rotate(0deg)'; } 
            else { container.style.display = 'grid'; header.classList.add('active'); icon.style.transform = 'rotate(180deg)'; }
        }

        function filtrarSociosRegistro() {
            const termino = document.getElementById('filtroRegistro').value.toLowerCase();
            const areas = document.querySelectorAll('.area-section');
            areas.forEach(area => {
                const containerId = area.querySelector('.cards-container').id;
                const container = document.getElementById(containerId);
                const cards = container.querySelectorAll('.socio-card');
                let foundInArea = false;
                cards.forEach(card => {
                    const text = card.getAttribute('data-search-name');
                    if(text.includes(termino)) { card.style.display = 'flex'; foundInArea = true; } else { card.style.display = 'none'; }
                });
                if (termino.length > 0) {
                    if (foundInArea) { area.style.display = 'block'; container.style.display = 'grid'; area.querySelector('.arrow-icon').style.transform = 'rotate(180deg)'; } else { area.style.display = 'none'; }
                } else { area.style.display = 'block'; container.style.display = 'none'; cards.forEach(c => c.style.display = 'flex'); area.querySelector('.arrow-icon').style.transform = 'rotate(0deg)'; }
            });
        }

        function prepararEdicion(id) {
            const socio = cacheSocios.find(s => s.id === id);
            if(socio) {
                isEditing = true;
                document.getElementById('editId').value = socio.id;
                document.getElementById('nombre').value = socio.nombre;
                document.getElementById('apellido').value = socio.apellido;
                document.getElementById('fechaIngreso').value = socio.fechaIngreso;
                let areaVal = socio.area;
                if(areaVal === 'GastosComision' || areaVal.includes('gastos')) areaVal = 'GastosComision';
                document.getElementById('area').value = areaVal;
                document.getElementById('contrato').value = socio.contrato;
                document.getElementById('modalTitle').innerText = 'Editar Socio';
                document.getElementById('btnSubmit').innerText = 'Actualizar Datos';
                abrirModalRegistro();
            }
        }
        async function eliminarSocio(id) {
            if(!confirm('¬øEliminar socio?')) return;
            toggleLoader(true, "Eliminando...");
            try { await callApiSocios('deleteSocio', { socioId: id }); showToast('Eliminado', 'error'); fetchSociosDeGoogle(); } 
            catch(e) { showToast('Error', 'error'); toggleLoader(false); }
        }

        function filtrarSociosGestion() { renderizarListaBusqueda(); }
        function renderizarListaBusqueda() {
            const termino = document.getElementById('buscadorGestion').value.toLowerCase();
            const lista = document.getElementById('listaResultados');
            lista.innerHTML = '';
            const filtrados = cacheSocios.filter(s => s.nombre.toLowerCase().includes(termino) || s.apellido.toLowerCase().includes(termino));
            if (filtrados.length === 0) { lista.innerHTML = '<div style="padding:10px; color:#999;">No encontrado.</div>'; return; }
            filtrados.forEach(s => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `<strong>${s.nombre} ${s.apellido}</strong> <span style="font-size:0.8em; color:#777;">(${s.contrato})</span>`;
                div.onclick = () => seleccionarSocio(s.id);
                lista.appendChild(div);
            });
        }
        function seleccionarSocio(id) {
            const socio = cacheSocios.find(s => s.id === id);
            if (!socio) return;
            document.getElementById('panelDetalle').style.display = 'block';
            document.getElementById('mensajeSeleccion').style.display = 'none';
            document.getElementById('gestionSocioId').value = socio.id;
            document.getElementById('gestionSocioNombre').value = `${socio.nombre} ${socio.apellido}`;
            document.getElementById('gestionSocioPuntos').value = socio.puntos; 
            
            document.getElementById('detNombre').textContent = `${socio.nombre} ${socio.apellido}`;
            document.getElementById('detContrato').textContent = socio.contrato;
            document.getElementById('detArea').textContent = "√Årea: " + (socio.area || '').toUpperCase();
            document.getElementById('detPuntos').textContent = socio.puntos;
            document.getElementById('cardAusencias').style.display = (socio.contrato === 'Planta') ? 'block' : 'none';
            
            // CONFIGURAR TARJETA DE D√çAS (Solo Part-Time)
            const cardDias = document.getElementById('cardDiasTrabajados');
            if(socio.contrato === 'Part-Time') {
                cardDias.style.display = 'block';
                document.getElementById('socioDiasCount').innerText = '...';
            } else {
                cardDias.style.display = 'none';
            }

            // INDICADOR DE CARGA
            const loadingText = '<span style="color:#999; font-size:0.8em;">Cargando... ‚è≥</span>';
            document.getElementById('socioSaldoAnterior').innerHTML = loadingText;
            document.getElementById('socioAlcance').innerHTML = loadingText;
            document.getElementById('socioTotalPedido').innerHTML = loadingText;
            document.getElementById('socioSaldo').innerHTML = loadingText;

            cargarHistorialSocio(id);
        }

        async function cargarHistorialSocio(id) {
            const tbody = document.getElementById('tablaHistorial');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;"><div class="spinner" style="width:20px;height:20px;margin:0 auto;"></div> Cargando...</td></tr>';
            try {
                const response = await fetch(`${URL_SOCIOS}?action=getDatosSocio&socioId=${id}`);
                const res = await response.json();
                tbody.innerHTML = ''; 
                if (res.status === 'success') {
                    const data = res.data || {};
                    const agrupados = {};
                    let sumaTotalPedido = 0; 

                    // Saldo Anterior
                    const saldoAnterior = Number(data.saldoAnterior || 0);
                    document.getElementById('socioSaldoAnterior').innerText = formatearMoneda(saldoAnterior);
                    document.getElementById('gestionSocioSaldoAnt').value = saldoAnterior;

                    // D√≠as Trabajados (Part-Time)
                    const socio = cacheSocios.find(s => s.id === id);
                    if(socio.contrato === 'Part-Time') {
                        selectedDaysPT = data.diasTrabajados || [];
                        document.getElementById('socioDiasCount').innerText = selectedDaysPT.length;
                    }

                    // Historial
                    const procesarEntrada = (fechaRaw, tipo, detalle, monto) => {
                        let fechaKey = fechaRaw || "";
                        if(fechaKey.includes('T')) fechaKey = fechaKey.split('T')[0];
                        if(!fechaKey) return;
                        if(!agrupados[fechaKey]) {
                            agrupados[fechaKey] = { fecha: fechaKey, tipos: new Set([tipo]), detalles: detalle ? [detalle] : [], montoTotal: monto, rawDate: new Date(fechaRaw) };
                        } else {
                            agrupados[fechaKey].tipos.add(tipo);
                            if(detalle && !agrupados[fechaKey].detalles.includes(detalle)) agrupados[fechaKey].detalles.push(detalle);
                            agrupados[fechaKey].montoTotal = Math.max(agrupados[fechaKey].montoTotal, monto);
                        }
                    };
                    
                    if(data.anticipos && Array.isArray(data.anticipos)) data.anticipos.forEach(a => procesarEntrada(a.fecha, 'Anticipo', 'Adelanto', Number(a.cantidad || a.monto || 0)));
                    if(data.extras && Array.isArray(data.extras)) data.extras.forEach(e => procesarEntrada(e.fecha, (e.tipo || 'Extra').toUpperCase(), e.detalle, 0));
                    
                    const listaFinal = Object.values(agrupados);
                    listaFinal.forEach(item => { sumaTotalPedido += item.montoTotal; });
                    
                    // C√ÅLCULO FINANCIERO INTELIGENTE (Planta vs Part-Time)
                    const ptsSocio = parseFloat(document.getElementById('gestionSocioPuntos').value) || 0;
                    let alcance = 0;

                    if (socio.contrato === 'Part-Time') {
                        // Calcular alcance sumando valor punto de los d√≠as seleccionados
                        let sumaValorPuntosPT = 0;
                        selectedDaysPT.forEach(dia => {
                            if(globalMapaPuntosDia[dia]) sumaValorPuntosPT += globalMapaPuntosDia[dia];
                        });
                        alcance = sumaValorPuntosPT * ptsSocio;
                    } else {
                        // Planta: Alcance global total
                        alcance = globalValorPuntoTotal * ptsSocio;
                    }

                    const saldo = (alcance + saldoAnterior) - sumaTotalPedido;

                    document.getElementById('socioTotalPedido').innerText = formatearMoneda(sumaTotalPedido);
                    document.getElementById('socioAlcance').innerText = formatearMoneda(alcance);
                    document.getElementById('socioSaldo').innerText = formatearMoneda(saldo);

                    if(listaFinal.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">No hay movimientos registrados.</td></tr>'; return; }
                    listaFinal.sort((a,b) => b.rawDate - a.rawDate); 
                    listaFinal.forEach(item => {
                        const row = document.createElement('tr');
                        let fechaVis = item.fecha;
                        if(fechaVis.includes('-')) { const f = fechaVis.split('-'); if(f.length === 3) fechaVis = `${f[2]}/${f[1]}/${f[0]}`; }
                        const tiposArr = Array.from(item.tipos);
                        let tipoHtml = tiposArr.includes('AUSENCIA') ? '<span class="tag-absent">AUSENCIA</span>' : `<span style="font-weight:bold; color:#555;">${tiposArr.join(' + ')}</span>`;
                        const detalleHtml = [...new Set(item.detalles)].join(', ') || '-';
                        const montoHtml = item.montoTotal > 0 ? `<span class="amount-minus">-${formatearMoneda(item.montoTotal)}</span>` : '-';
                        row.innerHTML = `<td>${fechaVis}</td><td>${tipoHtml}</td><td>${detalleHtml}</td><td>${montoHtml}</td>`;
                        tbody.appendChild(row);
                    });
                } else { 
                    tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error: ${res.message}</td></tr>`;
                    document.getElementById('socioSaldoAnterior').innerText = "$0";
                    document.getElementById('socioAlcance').innerText = "$0";
                    document.getElementById('socioTotalPedido').innerText = "$0";
                    document.getElementById('socioSaldo').innerText = "$0";
                }
            } catch (e) { console.error("Error JS:", e); tbody.innerHTML = '<tr><td colspan="4" style="color:red; text-align:center;">Error procesando datos</td></tr>'; }
        }

        async function cargarRecaudaciones(silent = false) {
            if(!URL_RECAUDACIONES || URL_RECAUDACIONES.includes("PEGA_AQUI")) { if(!silent) document.getElementById('contenedorFechas').innerHTML = '<div style="color:red; text-align:center;">Falta configurar URL</div>'; return; }
            if(!silent) toggleLoader(true, "Procesando recaudaciones...");
            try {
                const response = await fetch(`${URL_RECAUDACIONES}?action=get`);
                const result = await response.json();
                if(result.status !== 'success') throw new Error(result.message || "Error al cargar");
                const datos = result.data || []; const grupos = {}; let granTotal = 0; let ultimaFechaStr = "";
                
                globalValorPuntoTotal = 0;
                globalMapaPuntosDia = {}; // Reset mapa diario

                datos.forEach(item => {
                    const fecha = item.fecha; if (!fecha) return;
                    if (fecha > ultimaFechaStr) ultimaFechaStr = fecha;
                    if (!grupos[fecha]) grupos[fecha] = { fecha: fecha, divisor: 1.0, totalDia: 0, tipos: {} };
                    const monto = parseFloat(item.monto) || 0; grupos[fecha].totalDia += monto; granTotal += monto;
                    const tipo = item.tipo || 'Sin Tipo'; if (!grupos[fecha].tipos[tipo]) grupos[fecha].tipos[tipo] = 0; grupos[fecha].tipos[tipo] += monto;
                    if (item.divisor) grupos[fecha].divisor = item.divisor;
                });
                
                const fechasOrdenadas = Object.keys(grupos).sort().reverse(); 
                let sumaPuntosGlobal = 0;
                fechasOrdenadas.forEach(fecha => {
                    const dia = grupos[fecha];
                    const divisor = parseFloat(dia.divisor) || 1;
                    const puntoNoche = dia.totalDia / divisor;
                    
                    // Guardar valor punto por d√≠a para Part-Time
                    globalMapaPuntosDia[fecha] = puntoNoche;
                    
                    sumaPuntosGlobal += puntoNoche;
                });
                globalValorPuntoTotal = sumaPuntosGlobal; 

                if(silent) return;

                document.getElementById('recGranTotal').innerText = formatearMoneda(granTotal);
                if (ultimaFechaStr && grupos[ultimaFechaStr]) {
                    const ultDia = grupos[ultimaFechaStr]; const partes = ultimaFechaStr.split('-');
                    document.getElementById('recTotalUltimoDia').innerText = formatearMoneda(ultDia.totalDia);
                    document.getElementById('recFechaUltimoDia').innerText = `${partes[2]}/${partes[1]}/${partes[0]}`;
                    document.getElementById('recDivisorActual').innerText = ultDia.divisor;
                }
                const container = document.getElementById('contenedorFechas'); container.innerHTML = '';
                if (fechasOrdenadas.length === 0) { container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No hay registros.</div>'; } else {
                    fechasOrdenadas.forEach(fecha => {
                        const dia = grupos[fecha]; const partes = fecha.split('-'); const fechaVisual = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        const divisor = parseFloat(dia.divisor) || 1; const puntoNoche = dia.totalDia / divisor;
                        let tiposHtml = ''; for (const [nombreTipo, valorTipo] of Object.entries(dia.tipos)) { tiposHtml += `<div class="type-item"><span class="type-name">${nombreTipo}</span><span class="type-value">${formatearMoneda(valorTipo)}</span></div>`; }
                        const card = document.createElement('div'); card.className = 'date-card'; card.setAttribute('data-search', `${fechaVisual} ${dia.totalDia} ${Object.keys(dia.tipos).join(' ')}`);
                        card.innerHTML = `<div class="date-header"><div><div class="date-title">üìÖ ${fechaVisual}<span class="date-divisor" title="Divisor">√∑ ${dia.divisor}</span></div><div style="margin-top:5px;"><span class="date-point-badge">Punto Noche: ${formatearMoneda(puntoNoche)}</span></div></div><div class="date-total"><small style="display:block; font-size:0.6em; color:#999; font-weight:normal;">RECAUDADO</small>${formatearMoneda(dia.totalDia)}</div></div><div class="type-grid">${tiposHtml}</div>`;
                        container.appendChild(card);
                    });
                }
                document.getElementById('recTotalPuntos').innerText = formatearMoneda(sumaPuntosGlobal);
            } catch (error) { console.error(error); if(!silent) showToast("Error al obtener datos", "error"); } finally { if(!silent) toggleLoader(false); }
        }
        function filtrarRecaudacion() {
            const filter = document.getElementById('filtroRecaudacion').value.toLowerCase();
            const cards = document.querySelectorAll('.date-card');
            cards.forEach(card => {
                const text = card.getAttribute('data-search').toLowerCase();
                card.style.display = text.includes(filter) ? 'block' : 'none';
            });
        }
        function formatearMoneda(valor) { return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(valor); }
        async function enviarAnticipo() {
            const id = document.getElementById('gestionSocioId').value;
            const nombre = document.getElementById('gestionSocioNombre').value;
            const monto = document.getElementById('montoAnticipo').value;
            const fecha = document.getElementById('fechaAnticipo').value;
            if(!monto || !fecha) return showToast('Falta datos', 'error');
            toggleLoader(true);
            try { await callApiSocios('registrarBatchAnticipos', { detalleAnticipos: [{ id, nombre, fecha, monto: parseInt(monto) }] }); showToast('Registrado', 'success'); document.getElementById('montoAnticipo').value = ''; cargarHistorialSocio(id); } catch(e) { showToast('Error', 'error'); } finally { toggleLoader(false); }
        }
        async function enviarAusencia() {
            const id = document.getElementById('gestionSocioId').value;
            const nombre = document.getElementById('gestionSocioNombre').value;
            const fecha = document.getElementById('fechaAusencia').value;
            const motivo = document.getElementById('motivoAusencia').value;
            if(!fecha || !motivo) return showToast('Falta datos', 'error');
            toggleLoader(true);
            try { await callApiSocios('registrarBatchExtras', { detalleExtras: [{ id, nombre, fecha, tipo: 'ausencia', monto: 0, detalle: `Ausencia: ${motivo}` }] }); showToast('Registrado', 'success'); document.getElementById('motivoAusencia').value = ''; cargarHistorialSocio(id); } catch(e) { showToast('Error', 'error'); } finally { toggleLoader(false); }
        }
        function showToast(message, type = 'info') {
            const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = message; c.appendChild(t);
            setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
        }
    </script>
</body>
</html>