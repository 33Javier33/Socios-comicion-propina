<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Propina</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --menu-width: 250px;
            --primary-color: #3498db;
            --primary-hover-color: #2980b9;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --light-bg: #eef2f6;
            --white-bg: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #555;
            --border-color: #e0e6ed;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: #333;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- NUEVA ESTRUCTURA: MENÚ LATERAL Y CONTENEDOR PRINCIPAL --- */
        .menu-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1002;
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
        }
        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background-color: white;
            margin: 2px 0;
            transition: all 0.3s ease;
        }
        .side-menu.open + .main-container .menu-toggle {
            left: calc(var(--menu-width) + 15px);
        }
        .menu-toggle.active span:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        .menu-toggle.active span:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--menu-width);
            height: 100%;
            background-color: var(--text-dark);
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .side-menu.open {
            transform: translateX(0);
        }
        .side-menu .menu-header {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            text-align: center;
            padding: 20px 10px;
            border-bottom: 1px solid #4a627a;
        }
        .side-menu a {
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            display: block;
            font-size: 1.0em;
            transition: background-color 0.2s ease, padding-left 0.2s ease;
            border-bottom: 1px solid #3e5268;
        }
        .side-menu a:hover, .side-menu a.active-link {
            background-color: var(--primary-color);
            padding-left: 25px;
        }
        .main-container {
            transition: margin-left 0.3s ease;
            padding: 15px;
        }
        .main-container.menu-open {
            margin-left: var(--menu-width);
        }
        /* --- FIN NUEVA ESTRUCTURA --- */

        .container {
            max-width: 960px;
            margin: 10px auto;
            background-color: var(--white-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
        }
        h1 {
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.8em;
            padding-top: 45px; /* Espacio para el botón hamburguesa */
        }
        h2 {
            color: var(--primary-color);
            margin: 0 0 20px 0;
            font-weight: 600;
            font-size: 1.5em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* --- NUEVO ESTILO PARA PANELES DE CONTENIDO --- */
        .content-panel {
            display: none;
        }
        .content-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95em;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 18px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        button {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 8px;
        }
        button:hover {
            background-color: #27ae60;
            transform: translateY(-1px);
        }
        button.delete-btn {
            background-color: var(--danger-color);
            margin-top: 12px;
        }
        button.delete-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        
        /* --- ESTILO PARA EL NUEVO BOTÓN DE IMPORTACIÓN --- */
        .import-sheets-btn {
            background-color: #9b59b6;
            margin-bottom: 20px;
        }
        .import-sheets-btn:hover {
            background-color: #8e44ad;
        }

        .socio-card-container, .monto-card-container, .retiro-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 20px;
        }
        .socio-planta-container, .socio-part-time-container, .distribucion-planta-container, .distribucion-part-time-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .socio-planta-container h3, .socio-part-time-container h3, .distribucion-planta-container h3, .distribucion-part-time-container h3 {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.4em;
            font-weight: 700;
        }


        .socio-card, .monto-card, .retiro-card, .socio-distribucion-card {
            background-color: #f7f9fc;
            border: 1px solid #dbe9f5;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            word-wrap: break-word;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        .socio-card:hover, .monto-card:hover, .retiro-card:hover, .socio-distribucion-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.09);
        }
        .socio-card h3, .monto-card h3, .retiro-card h3, .socio-distribucion-card h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.25em;
            font-weight: 700;
        }
        .socio-card p, .monto-card p, .retiro-card p, .socio-distribucion-card p {
            margin: 6px 0;
            font-size: 0.9em;
            color: #444;
        }
        .socio-card strong, .monto-card strong, .retiro-card strong, .socio-distribucion-card strong {
            color: var(--text-dark);
            font-weight: 600;
        }
        .socio-card .delete-button-wrapper, .monto-card .delete-button-wrapper, .retiro-card .delete-button-wrapper, .socio-distribucion-card .delete-button-wrapper {
            text-align: center;
            margin-top: 12px;
        }
        .socio-card .delete-button-wrapper button, .monto-card .delete-button-wrapper button, .retiro-card .delete-button-wrapper button, .socio-distribucion-card .delete-button-wrapper button {
            width: auto;
            padding: 7px 12px;
            font-size: 0.85em;
        }

        .monto-card .monto-entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed var(--border-color);
            padding: 5px 0;
            cursor: pointer;
        }
        .monto-card .monto-entry-item:last-child {
            border-bottom: none;
        }
        .monto-card .monto-entry-item span {
            flex-grow: 1;
        }
        .monto-card .monto-entry-item .delete-btn {
            width: auto;
            padding: 3px 8px;
            margin-left: 10px;
            font-size: 0.75em;
            background-color: var(--danger-color);
            border-radius: 4px;
        }
        .monto-card .monto-entry-item .delete-btn:hover {
            background-color: #c0392b;
        }
        .monto-card .date-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dbe9f5;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
            text-align: right;
        }

        .general-total {
            background-color: var(--secondary-color);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }
        .general-total-retiros {
            background-color: var(--danger-color);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }

        .punto-planta-display-general {
            background-color: #9b59b6;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
        }


        .show-daily-totals-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            width: 100%;
            margin-bottom: 15px;
            display: block;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .show-daily-totals-btn:hover {
            background-color: var(--primary-hover-color);
        }

        .show-punto-planta-btn {
            background-color: #9b59b6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            display: block;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        .show-punto-planta-btn:hover {
            background-color: #8e44ad;
        }

        .socio-card .part-time-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px solid #dbe9f5;
            padding-top: 10px;
        }
        .socio-card .part-time-actions button {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.9em;
            border-radius: 5px;
        }
        .socio-card .part-time-actions .calendar-btn {
            background-color: #f39c12;
        }
        .socio-card .part-time-actions .calendar-btn:hover {
            background-color: #e67e22;
        }
        .socio-card .part-time-actions .calculate-part-time-points-btn {
            background-color: #1abc9c;
        }
        .socio-card .part-time-actions .calculate-part-time-points-btn:hover {
            background-color: #16a085;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 18px;
            font-size: 1.4em;
        }
        .modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
        }

        .daily-totals-list p, .punto-planta-details p, .part-time-points-details p, .socio-anticipos-list p {
            margin: 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px dashed #eee;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
        }
        .daily-totals-list p:last-child, .punto-planta-details p:last-child, .part-time-points-details p:last-child, .socio-anticipos-list p:last-child {
            border-bottom: none;
        }
        .daily-totals-list strong, .punto-planta-details strong, .part-time-points-details strong, .socio-anticipos-list strong {
            color: #34495e;
        }

        .punto-planta-result-card {
            background-color: #e6ffee;
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            color: #28a745;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2);
        }

        .part-time-points-result-card {
            background-color: #e0f8f5;
            border: 1px solid #1abc9c;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            color: #1abc9c;
            box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2);
        }


        .edit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        .edit-modal-content {
            background-color: #fefefe;
            padding: 25px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }

        .edit-modal-content h3 {
            margin-top: 0;
            color: var(--text-dark);
            text-align: center;
            margin-bottom: 18px;
            font-size: 1.4em;
        }
        .edit-modal-content button {
            margin-top: 15px;
        }
        .edit-modal-content button.cancel-btn {
            background-color: #95a5a6;
        }
        .edit-modal-content button.cancel-btn:hover {
            background-color: #7f8c8d;
        }

        .socio-distribucion-card {
            border: 1px solid #cce7ff;
            background-color: #e0f2ff;
            cursor: pointer;
        }
        .socio-distribucion-card.part-time {
            background-color: #fffde0;
            border-color: #ffeb3b;
        }
        .socio-distribucion-card p.puntos {
            font-size: 1.0em;
            font-weight: 700;
            color: #007bff;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 0;
        }
        .socio-distribucion-card p.puntos-calculados-pt {
            font-size: 1.1em;
            font-weight: 700;
            color: #1abc9c;
            text-align: center;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .socio-distribucion-card p.propina-asignada,
        .socio-distribucion-card p.saldo-disponible {
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            margin-top: 5px;
        }
        .socio-distribucion-card p.propina-asignada {
            color: #28a745;
        }
        .socio-distribucion-card p.saldo-disponible {
            color: var(--primary-color);
        }
        .socio-distribucion-card p.saldo-disponible.negative {
            color: var(--danger-color);
        }

        #calendarModal .modal-content {
            max-width: 320px;
            padding: 20px;
        }
        #calendarModal h3 {
            margin-bottom: 10px;
        }
        #flatpickrInput {
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
        }

        .anticipo-socio-info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .anticipo-socio-info h3 {
            color: #1890ff;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3em;
        }
        .anticipo-socio-info p {
            font-size: 1em;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .anticipo-socio-info p strong {
            color: #333;
        }
        .anticipo-socio-info .saldo-disponible {
            font-size: 1.2em;
            font-weight: 700;
            color: #28a745;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #dbe9f5;
            text-align: right;
        }
        .anticipo-socio-info .saldo-disponible.negative {
            color: var(--danger-color);
        }

        .anticipo-history {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        .anticipo-history h4 {
            color: var(--text-light);
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.1em;
        }
        .anticipo-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.9em;
        }
        .anticipo-history-item:last-child {
            border-bottom: none;
        }
        .anticipo-history-item .delete-btn {
            background-color: var(--danger-color);
            padding: 4px 8px;
            font-size: 0.75em;
            border-radius: 4px;
            width: auto;
            margin-left: 10px;
        }
        .anticipo-history-item .delete-btn:hover {
            background-color: #c0392b;
        }

        #socioAnticiposHistoryModal .modal-content {
            max-width: 450px;
        }
        #socioAnticiposHistoryModal .socio-summary {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #cce7ff;
        }
        #socioAnticiposHistoryModal .socio-summary p {
            margin: 5px 0;
            font-size: 1em;
        }
        #socioAnticiposHistoryModal .socio-summary .saldo-disponible {
            font-size: 1.2em;
            font-weight: 700;
            color: #28a745;
            text-align: right;
            border-top: 1px solid #dbe9f5;
            padding-top: 10px;
            margin-top: 10px;
        }
        #socioAnticiposHistoryModal .socio-summary .saldo-disponible.negative {
            color: var(--danger-color);
        }
        #socioAnticiposHistoryModal .socio-anticipos-list {
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #socioAnticiposHistoryModal .socio-anticipos-list h4 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--text-light);
            font-size: 1.1em;
        }

        .import-export-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .import-export-container button, .import-export-container input[type="file"] {
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }
        .import-export-container input[type="file"] {
            display: none;
        }
        .import-export-container .import-label {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            max-width: 300px;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .import-export-container .import-label:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }
        .export-btn {
            background-color: #f1c40f;
        }
        .export-btn:hover {
            background-color: #f39c12;
        }
        
        .delete-all-btn {
            background-color: var(--danger-color);
        }
        .delete-all-btn:hover {
            background-color: #c0392b;
        }

        #balanceReport {
            padding: 15px;
            border-radius: 8px;
            background-color: #ecf0f1;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #balanceReport p {
            margin: 0;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            font-size: 1em;
            color: var(--text-light);
        }
        #balanceReport p strong {
            color: var(--text-dark);
        }
        #balanceReport p:first-child {
            border-bottom: 1px dashed #dcdcdc;
        }
        #balanceReport .balance-saldo {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-dark);
            text-align: right;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #dbe9f5;
        }
        .balance-saldo span.negative {
            color: var(--danger-color);
        }
        .balance-saldo span.positive {
            color: var(--secondary-color);
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        .search-container input {
            width: 100%;
        }

        @media (min-width: 992px) {
            .menu-toggle {
                display: none;
            }
            .side-menu {
                transform: translateX(0);
            }
            .main-container {
                margin-left: var(--menu-width);
            }
            .container h1 {
                padding-top: 0;
            }
        }
        @media (max-width: 991px) {
             .main-container.menu-open {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <nav id="sideMenu" class="side-menu">
        <div class="menu-header">Menú</div>
        <a href="#" class="menu-link active-link" data-target="balanceContent">Balance General</a>
        <a href="#" class="menu-link" data-target="registroContent">Registrar Socio</a>
        <a href="#" class="menu-link" data-target="sociosContent">Socios Comisión</a>
        <a href="#" class="menu-link" data-target="registroMontosContent">Registrar Monto Noche</a>
        <a href="#" class="menu-link" data-target="montosContent">Montos Registrados</a>
        <a href="#" class="menu-link" data-target="anticiposContent">Anticipos de Socios</a>
        <a href="#" class="menu-link" data-target="distribucionContent">Distribución de Propina</a>
        <a href="#" class="menu-link" data-target="dataManagementContent">Gestión de Datos</a>
    </nav>
    <div class="main-container" id="mainContainer">
        <button class="menu-toggle" id="menuToggle">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <div class="container">
            <h1>Gestión de Propina</h1>

            <div id="balanceContent" class="content-panel active">
                <h2>Balance General</h2>
                <div id="balanceReport">
                    <p><strong>Total Propina Bruta:</strong> <span id="balancePropinaBruta">$0</span></p>
                    <p><strong>Total Anticipos:</strong> <span id="balanceAnticipos">$0</span></p>
                    <hr>
                    <p class="balance-saldo"><strong>Saldo Disponible:</strong> <span id="balanceSaldo">$0</span></p>
                </div>
            </div>
            
            <div id="registroContent" class="content-panel">
                <h2>Registrar Socio</h2>
                <form id="registroSocioForm">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" required>
                    <label for="apellido">Apellido:</label>
                    <input type="text" id="apellido" required>
                    <label for="fechaIngreso">Fecha de Ingreso:</label>
                    <input type="date" id="fechaIngreso" required>
                    <label for="area">Área:</label>
                    <select id="area" required>
                        <option value="">Seleccione un área</option>
                        <option value="Mesas">Mesas</option>
                        <option value="Maquinas">Máquinas</option>
                        <option value="Boveda">Bóveda</option>
                    </select>
                    <label for="tipoContrato">Tipo de Contrato:</label>
                    <select id="tipoContrato" required>
                        <option value="">Seleccione tipo de contrato</option>
                        <option value="Planta">Planta</option>
                        <option value="Part-Time">Part-Time</option>
                    </select>
                    <button type="submit">Registrar Socio</button>
                </form>
            </div>

            <div id="sociosContent" class="content-panel">
                <h2>Socios Comisión</h2>
                <div class="socio-planta-container" id="sociosPlantaContainer">
                    <h3>Socios Planta</h3>
                </div>
                <div class="socio-part-time-container" id="sociosPartTimeContainer">
                    <h3>Socios Part-Time</h3>
                </div>
            </div>

            <div id="registroMontosContent" class="content-panel">
                <h2>Registrar Monto Noche</h2>
                <div class="general-total" id="totalGeneralMontosRegistro">
                    Total General de Propina: $0
                </div>
                <button type="button" class="show-daily-totals-btn" data-modal-target="dailyTotalsModal">Ver Totales Diarios de Propina</button>
                
                <!-- INICIO: BOTÓN DE IMPORTACIÓN AÑADIDO -->
                <button type="button" class="import-sheets-btn" id="importFromSheetsBtn">Importar desde Sheets</button>
                <!-- FIN: BOTÓN DE IMPORTACIÓN AÑADIDO -->

                <form id="registroMontoForm">
                    <label for="montoFecha">Fecha:</label>
                    <input type="date" id="montoFecha" required>
                    <label for="montoArea">Área:</label>
                    <select id="montoArea" required>
                        <option value="">Seleccione un área</option>
                        <option value="Mesas">Mesas</option>
                        <option value="Maquinas">Máquinas</option>
                        <option value="Boveda">Bóveda</option>
                    </select>
                    <label for="montoCantidad">Monto:</label>
                    <input type="text" id="montoCantidad" inputmode="numeric" pattern="[0-9.]*" required>
                    <button type="submit">Registrar Monto</button>
                </form>
            </div>

            <div id="montosContent" class="content-panel">
                <h2>Montos Registrados</h2>
                <div class="general-total" id="totalGeneralMontosDisplay">
                    Total General de Propina: $0
                </div>
                <button type="button" class="show-daily-totals-btn" data-modal-target="dailyTotalsModal">Ver Totales Diarios de Propina</button>
                <div id="montosRegistradosContainer" class="monto-card-container"></div>
            </div>

            <div id="anticiposContent" class="content-panel">
                <h2>Anticipos de Socios</h2>
                <div class="general-total-retiros" id="totalGeneralAnticipos">
                    Total General de Anticipos: $0
                </div>
                <form id="registroAnticipoForm">
                    <label for="anticipoSocioInput">Seleccionar Socio:</label>
                    <input list="sociosAnticipoList" id="anticipoSocioInput" type="text" placeholder="Buscar socio..." required>
                    <datalist id="sociosAnticipoList"></datalist>
                    <input type="hidden" id="anticipoSocioId">
                    <div id="anticipoSocioInfoContainer" class="anticipo-socio-info" style="display: none;">
                        <h3>Información del Socio</h3>
                        <p><strong>Propina Asignada:</strong> <span id="infoPropinaAsignada">$0</span></p>
                        <p><strong>Total Anticipos Anteriores:</strong> <span id="infoAnticiposAnteriores">$0</span></p>
                        <p class="saldo-disponible"><strong>Saldo Disponible:</strong> <span id="infoSaldoDisponible">$0</span></p>
                        <div class="anticipo-history" id="anticipoHistoryDisplay">
                            <h4>Historial de Anticipos</h4>
                            <p style="text-align: center;">No hay anticipos previos.</p>
                        </div>
                    </div>
                    <label for="anticipoFecha">Fecha de Anticipo:</label>
                    <input type="date" id="anticipoFecha" required>
                    <label for="anticipoCantidad">Monto del Anticipo:</label>
                    <input type="text" id="anticipoCantidad" inputmode="numeric" pattern="[0-9.]*" required>
                    <button type="submit">Registrar Anticipo</button>
                </form>
                <div id="anticiposRegistradosContainer" class="retiro-card-container" style="display: none;"></div>
            </div>

            <div id="distribucionContent" class="content-panel">
                <h2>Distribución de Propina</h2>
                <div class="general-total" id="totalGeneralPropinaBrutaDistribucion">
                    Total General de Propina (Bruta): $0
                </div>
                <div class="punto-planta-display-general" id="puntoPlantaDisplay">
                    Último Punto-Planta: $0
                </div>
                <button type="button" class="show-punto-planta-btn" data-modal-target="puntoPlantaModal">Calcular Punto-Planta</button>
                <div class="search-container">
                    <input type="text" id="socioSearchInput" placeholder="Buscar socio...">
                </div>
                <div class="distribucion-planta-container" id="distribucionPlantaContainer">
                    <h3>Socios Planta</h3>
                </div>
                <div class="distribucion-part-time-container" id="distribucionPartTimeContainer">
                    <h3>Socios Part-Time</h3>
                </div>
            </div>
            
            <div id="dataManagementContent" class="content-panel">
                <h2>Gestión de Datos</h2>
                <p>Aquí puedes exportar tus datos para crear una copia de seguridad, importar una copia o borrar los datos del período actual.</p>
                <div class="import-export-container">
                    <button id="exportDataBtn" class="export-btn">Exportar Datos (JSON)</button>
                    <button id="deleteAllDataBtn" class="delete-all-btn">Borrar Montos y Anticipos</button>
                    <label for="importFileInput" class="import-label">Importar Datos (JSON)</label>
                    <input type="file" id="importFileInput" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="dailyTotalsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="dailyTotalsModal">&times;</span>
            <h3>Totales Diarios de Montos</h3>
            <div class="daily-totals-list">
                <p>Cargando totales...</p>
            </div>
        </div>
    </div>
    <div id="puntoPlantaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="puntoPlantaModal">&times;</span>
            <h3>Cálculo de Punto-Planta</h3>
            <div class="punto-planta-details">
                <p><strong>Total de Propina Bruta:</strong> <span id="propinaBrutaModal">$0</span></p>
                <p><strong>Total de Anticipos:</strong> <span id="retirosModal">$0</span></p>
                <p><strong>Total de Propina Neta (Disponible para Punto-Planta):</strong> <span id="propinaNetaModal">$0</span></p>
                <p><strong>Total de Puntos de Socios:</strong> <span id="totalPuntosSociosModal">0</span></p>
                <hr style="margin: 15px 0;">
                <label for="divisorPuntoPlanta">Divisor para Punto-Planta:</label>
                <input type="text" id="divisorPuntoPlanta" inputmode="numeric" pattern="[0-9.]*" required style="width: calc(100% - 20px);">
                <button type="button" id="calcularPuntoPlantaInternoBtn">Calcular Punto-Planta</button>
                <div class="punto-planta-result-card" id="puntoPlantaValor">
                    Punto-Planta: $0
                </div>
            </div>
        </div>
    </div>
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="calendarModal">&times;</span>
            <h3 id="calendarModalTitle">Días Trabajados de [Socio]</h3>
            <input type="text" id="flatpickrInput" placeholder="Selecciona días">
            <p style="text-align: center; margin-top: 15px;">Días seleccionados: <span id="selectedDaysCount">0</span></p>
        </div>
    </div>
    <div id="partTimePointsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="partTimePointsModal">&times;</span>
            <h3 id="partTimePointsModalTitle">Calcular Puntos de [Socio Part-Time]</h3>
            <div class="part-time-points-details">
                <p><strong>Puntos de Antigüedad Base:</strong> <span id="partTimeModalBasePoints">0</span></p>
                <p><strong>Monto Propina Asignable (del total bruto):</strong> <span id="partTimeModalAssignableAmount">$0</span></p>
                <hr style="margin: 15px 0;">
                <label for="partTimeMultiplicador">Multiplicador de Puntos:</label>
                <input type="text" id="partTimeMultiplicador" inputmode="numeric" pattern="[0-9.]*" required style="width: calc(100% - 20px);">
                <button type="button" id="calcularPartTimePointsInternoBtn">Calcular Puntos</button>
                <div class="part-time-points-result-card" id="partTimePointsValue">
                    Puntos: 0
                </div>
            </div>
        </div>
    </div>
    <div id="editModal" class="edit-modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="editModal">&times;</span>
            <h3 id="editModalTitle">Editar</h3>
            <form id="editFormUniversal">
                <input type="hidden" id="editItemType">
                <input type="hidden" id="editItemIndex">
                <div id="editFieldsSocio">
                    <label for="editNombre">Nombre:</label>
                    <input type="text" id="editNombre">
                    <label for="editApellido">Apellido:</label>
                    <input type="text" id="editApellido">
                    <label for="editFechaIngreso">Fecha de Ingreso:</label>
                    <input type="date" id="editFechaIngreso">
                    <label for="editArea">Área:</label>
                    <select id="editArea">
                        <option value="Mesas">Mesas</option>
                        <option value="Maquinas">Máquinas</option>
                        <option value="Boveda">Bóveda</option>
                    </select>
                    <label for="editTipoContrato">Tipo de Contrato:</label>
                    <select id="editTipoContrato">
                        <option value="Planta">Planta</option>
                        <option value="Part-Time">Part-Time</option>
                    </select>
                </div>
                <div id="editFieldsMonto" style="display: none;">
                    <label for="editMontoFecha">Fecha:</label>
                    <input type="date" id="editMontoFecha">
                    <label for="editMontoArea">Área:</label>
                    <select id="editMontoArea">
                        <option value="Mesas">Mesas</option>
                        <option value="Maquinas">Máquinas</option>
                        <option value="Boveda">Bóveda</option>
                    </select>
                    <label for="editMontoCantidad">Monto:</label>
                    <input type="text" id="editMontoCantidad" inputmode="numeric" pattern="[0-9.]*">
                </div>
                <div id="editFieldsAnticipo" style="display: none;">
                    <label for="editAnticipoFecha">Fecha de Anticipo:</label>
                    <input type="date" id="editAnticipoFecha">
                    <label for="editAnticipoCantidad">Monto Anticipado:</label>
                    <input type="text" id="editAnticipoCantidad" inputmode="numeric" pattern="[0-9.]*">
                </div>
                <button type="submit">Guardar Cambios</button>
                <button type="button" class="cancel-btn">Cancelar</button>
            </form>
        </div>
    </div>
    <div id="socioAnticiposHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-close="socioAnticiposHistoryModal">&times;</span>
            <h3 id="socioAnticiposHistoryModalTitle">Historial de Anticipos de [Socio]</h3>
            <div class="socio-summary">
                <p><strong>Propina Asignada:</strong> <span id="modalSocioPropinaAsignada">$0</span></p>
                <p><strong>Total de Anticipos:</strong> <span id="modalSocioTotalAnticipos">$0</span></p>
                <p class="saldo-disponible"><strong>Saldo Disponible:</strong> <span id="modalSocioSaldo">$0</span></p>
            </div>
            <div class="socio-anticipos-list" id="modalSocioAnticiposList">
                <h4>Detalle de Anticipos</h4>
                <p style="text-align: center;">No hay anticipos registrados para este socio.</p>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menuToggle');
            const sideMenu = document.getElementById('sideMenu');
            const mainContainer = document.getElementById('mainContainer');
            const menuLinks = document.querySelectorAll('.menu-link');
            const contentPanels = document.querySelectorAll('.content-panel');
            
            menuToggle.addEventListener('click', () => {
                sideMenu.classList.toggle('open');
                menuToggle.classList.toggle('active');
                if (window.innerWidth > 991) {
                    mainContainer.classList.toggle('menu-open');
                }
            });

            menuLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetId = link.getAttribute('data-target');

                    contentPanels.forEach(panel => {
                        panel.classList.remove('active');
                    });
                    document.getElementById(targetId).classList.add('active');

                    menuLinks.forEach(l => l.classList.remove('active-link'));
                    link.classList.add('active-link');
                    
                    if (targetId === 'anticiposContent') {
                        updateAnticipoSocioSelector();
                    }
                    
                    if (window.innerWidth <= 991) {
                       sideMenu.classList.remove('open');
                       menuToggle.classList.remove('active');
                    }
                });
            });

            // --- INICIO: LÓGICA DE IMPORTACIÓN ---
            const importFromSheetsBtn = document.getElementById('importFromSheetsBtn');
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxna9EH5LZPTPCPws58pGro6qCrZ8_zNwvUkUHS28BYfd8CsAcD1MRcqlITbDm4lTk/exec'; 

            importFromSheetsBtn.addEventListener('click', async () => {
                if (!confirm('¿Deseas importar todos los datos de recaudación desde Google Sheets? Esto puede duplicar entradas si ya existen.')) {
                    return;
                }

                const originalText = importFromSheetsBtn.textContent;
                importFromSheetsBtn.textContent = 'Importando...';
                importFromSheetsBtn.disabled = true;

                try {
                    const response = await fetch(`${SCRIPT_URL}?action=get`);
                    if (!response.ok) {
                        throw new Error(`Error en la solicitud: ${response.statusText}`);
                    }
                    const result = await response.json();

                    if (result.status === 'success' && Array.isArray(result.data)) {
                        let montos = JSON.parse(localStorage.getItem('montos')) || [];
                        const nuevosMontos = result.data;

                        nuevosMontos.forEach(entry => {
                            let areaMapeada = 'Boveda';
                            if (entry.tipo === 'Máquinas') areaMapeada = 'Maquinas';
                            else if (entry.tipo === 'Mesas') areaMapeada = 'Mesas';

                            // Opcional: Evitar duplicados exactos
                            const existe = montos.some(m => m.fecha === entry.fecha && m.area === areaMapeada && m.cantidad === entry.monto);
                            if (!existe) {
                                montos.push({
                                    fecha: entry.fecha,
                                    area: areaMapeada,
                                    cantidad: entry.monto
                                });
                            }
                        });

                        localStorage.setItem('montos', JSON.stringify(montos));
                        alert(`¡Importación completada! Se procesaron ${nuevosMontos.length} registros.`);
                        cargarMontos(); // Actualizar la vista
                    } else {
                        throw new Error(result.message || 'La respuesta del script no fue exitosa.');
                    }
                } catch (error) {
                    console.error('Error durante la importación:', error);
                    alert(`Error al importar los datos: ${error.message}`);
                } finally {
                    importFromSheetsBtn.textContent = originalText;
                    importFromSheetsBtn.disabled = false;
                }
            });
            // --- FIN: LÓGICA DE IMPORTACIÓN ---


            // --- El resto del JS ---
            const registroSocioForm = document.getElementById('registroSocioForm');
            const sociosPlantaContainer = document.getElementById('sociosPlantaContainer');
            const sociosPartTimeContainer = document.getElementById('sociosPartTimeContainer');
            const registroMontoForm = document.getElementById('registroMontoForm');
            const montosRegistradosContainer = document.getElementById('montosRegistradosContainer');
            const registroAnticipoForm = document.getElementById('registroAnticipoForm');
            const totalGeneralAnticipos = document.getElementById('totalGeneralAnticipos');
            const sociosAnticipoList = document.getElementById('sociosAnticipoList');
            const anticipoSocioInput = document.getElementById('anticipoSocioInput');
            const anticipoSocioId = document.getElementById('anticipoSocioId');
            const anticipoSocioInfoContainer = document.getElementById('anticipoSocioInfoContainer');
            const infoPropinaAsignada = document.getElementById('infoPropinaAsignada');
            const infoAnticiposAnteriores = document.getElementById('infoAnticiposAnteriores');
            const infoSaldoDisponible = document.getElementById('infoSaldoDisponible');
            const anticipoHistoryDisplay = document.getElementById('anticipoHistoryDisplay');
            const totalGeneralMontosRegistro = document.getElementById('totalGeneralMontosRegistro');
            const totalGeneralMontosDisplay = document.getElementById('totalGeneralMontosDisplay');
            const totalGeneralPropinaBrutaDistribucion = document.getElementById('totalGeneralPropinaBrutaDistribucion'); 
            const puntoPlantaDisplay = document.getElementById('puntoPlantaDisplay'); 
            const distribucionPlantaContainer = document.getElementById('distribucionPlantaContainer');
            const distribucionPartTimeContainer = document.getElementById('distribucionPartTimeContainer');
            const balancePropinaBruta = document.getElementById('balancePropinaBruta');
            const balanceAnticipos = document.getElementById('balanceAnticipos');
            const balanceSaldo = document.getElementById('balanceSaldo');
            const dailyTotalsModal = document.getElementById('dailyTotalsModal');
            const dailyTotalsList = dailyTotalsModal.querySelector('.daily-totals-list');
            const puntoPlantaModal = document.getElementById('puntoPlantaModal');
            const propinaBrutaModal = document.getElementById('propinaBrutaModal');
            const retirosModal = document.getElementById('retirosModal');
            const propinaNetaModal = document.getElementById('propinaNetaModal');
            const totalPuntosSociosModal = document.getElementById('totalPuntosSociosModal');
            const divisorPuntoPlantaInput = document.getElementById('divisorPuntoPlanta');
            const calcularPuntoPlantaInternoBtn = document.getElementById('calcularPuntoPlantaInternoBtn');
            const puntoPlantaValor = document.getElementById('puntoPlantaValor');
            const editModal = document.getElementById('editModal');
            const closeEditModalButton = editModal.querySelector('.close-button');
            const editModalTitle = document.getElementById('editModalTitle');
            const editFormUniversal = document.getElementById('editFormUniversal');
            const cancelEditButton = editModal.querySelector('.cancel-btn');
            const editItemType = document.getElementById('editItemType');
            const editItemIndex = document.getElementById('editItemIndex');
            const editFieldsSocio = document.getElementById('editFieldsSocio');
            const editFieldsMonto = document.getElementById('editFieldsMonto');
            const editFieldsAnticipo = document.getElementById('editFieldsAnticipo');
            const editNombre = document.getElementById('editNombre');
            const editApellido = document.getElementById('editApellido');
            const editFechaIngreso = document.getElementById('editFechaIngreso');
            const editArea = document.getElementById('editArea');
            const editTipoContrato = document.getElementById('editTipoContrato');
            const editMontoFecha = document.getElementById('editMontoFecha');
            const editMontoArea = document.getElementById('editMontoArea');
            const editMontoCantidad = document.getElementById('editMontoCantidad');
            const editAnticipoFecha = document.getElementById('editAnticipoFecha');
            const editAnticipoCantidad = document.getElementById('editAnticipoCantidad');
            const calendarModal = document.getElementById('calendarModal');
            const calendarModalTitle = document.getElementById('calendarModalTitle');
            const flatpickrInput = document.getElementById('flatpickrInput');
            const selectedDaysCountSpan = document.getElementById('selectedDaysCount');
            let currentSocioIndexCalendar = -1;
            const partTimePointsModal = document.getElementById('partTimePointsModal');
            const partTimePointsModalTitle = document.getElementById('partTimePointsModalTitle');
            const partTimeModalBasePoints = document.getElementById('partTimeModalBasePoints');
            const partTimeModalAssignableAmount = document.getElementById('partTimeModalAssignableAmount');
            const partTimeMultiplicadorInput = document.getElementById('partTimeMultiplicador');
            const calcularPartTimePointsInternoBtn = document.getElementById('calcularPartTimePointsInternoBtn');
            const partTimePointsValue = document.getElementById('partTimePointsValue');
            let currentSocioIndexPartTimePoints = -1;
            const socioAnticiposHistoryModal = document.getElementById('socioAnticiposHistoryModal');
            const socioAnticiposHistoryModalTitle = document.getElementById('socioAnticiposHistoryModalTitle');
            const modalSocioPropinaAsignada = document.getElementById('modalSocioPropinaAsignada');
            const modalSocioTotalAnticipos = document.getElementById('modalSocioTotalAnticipos');
            const modalSocioSaldo = document.getElementById('modalSocioSaldo');
            const modalSocioAnticiposList = document.getElementById('modalSocioAnticiposList');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importFileInput = document.getElementById('importFileInput');
            const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
            const montoCantidadInput = document.getElementById('montoCantidad');
            const anticipoCantidadInput = document.getElementById('anticipoCantidad');
            const editMontoCantidadInput = document.getElementById('editMontoCantidad');
            const editAnticipoCantidadInput = document.getElementById('editAnticipoCantidad');
            const divisorPuntoPlantaInputEdit = document.getElementById('divisorPuntoPlanta');
            const socioSearchInput = document.getElementById('socioSearchInput');
            let flatpickrInstance;
            const formatNumber = (num) => {
                if (typeof num !== 'number') return num;
                return new Intl.NumberFormat('es-CL', { style: 'decimal', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
            };
            const parseNumber = (formattedNum) => {
                if (typeof formattedNum !== 'string' && typeof formattedNum !== 'number') return formattedNum;
                if (typeof formattedNum === 'number') return formattedNum;
                return parseFloat(formattedNum.replace(/\./g, '').replace(',', '.'));
            };
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : dateStr;
            };
            const calcularPuntosPropinaBase = (fechaIngresoStr, area, tipoContrato) => {
                const fechaIngreso = new Date(fechaIngresoStr + 'T00:00:00');
                const fechaActual = new Date();
                let puntosBase = 4;
                let topePuntos = area === 'Mesas' ? 20 : 12;
                let puntosCalculados = puntosBase;
                let anosTranscurridos = fechaActual.getFullYear() - fechaIngreso.getFullYear();
                if (fechaActual.getMonth() < fechaIngreso.getMonth() || (fechaActual.getMonth() === fechaIngreso.getMonth() && fechaActual.getDate() < fechaIngreso.getDate())) {
                    anosTranscurridos--;
                }
                puntosCalculados += anosTranscurridos * 2;
                if (tipoContrato === 'Planta') {
                    return { puntosConTope: Math.min(puntosCalculados, topePuntos), puntosSinTope: puntosCalculados };
                }
                return { puntosConTope: puntosCalculados, puntosSinTope: puntosCalculados };
            };
            const calcularMontoAsignablePartTime = (diasTrabajados) => {
                const montos = JSON.parse(localStorage.getItem('montos')) || [];
                return diasTrabajados.reduce((total, dia) => {
                    return total + montos.filter(m => m.fecha === dia).reduce((subTotal, monto) => subTotal + monto.cantidad, 0);
                }, 0);
            };
            const cargarSocios = () => {
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                sociosPlantaContainer.innerHTML = '<h3>Socios Planta</h3>';
                sociosPartTimeContainer.innerHTML = '<h3>Socios Part-Time</h3>';
                distribucionPlantaContainer.innerHTML = '<h3>Socios Planta</h3>';
                distribucionPartTimeContainer.innerHTML = '<h3>Socios Part-Time</h3>';
                socios.forEach((socio, index) => {
                    const puntosCalc = calcularPuntosPropinaBase(socio.fechaIngreso, socio.area, socio.tipoContrato);
                    if (socio.tipoContrato === 'Planta') {
                        socio.puntosPropina = puntosCalc.puntosConTope;
                        delete socio.diasTrabajados;
                        delete socio.montoAsignablePartTime;
                        delete socio.puntosAntiguedadBase;
                        delete socio.puntosPropinaPartTime;
                    } else {
                        socio.diasTrabajados = socio.diasTrabajados || [];
                        socio.puntosAntiguedadBase = puntosCalc.puntosSinTope;
                        socio.montoAsignablePartTime = calcularMontoAsignablePartTime(socio.diasTrabajados);
                        socio.puntosPropinaPartTime = socio.puntosPropinaPartTime || 0;
                        delete socio.puntosPropina;
                    }
                    socio.anticipos = socio.anticipos || [];
                    agregarSocioCard(socio, index);
                    agregarSocioDistribucionCard(socio, index);
                });
                guardarSocios(socios);
                updateGeneralTotals();
                updatePropinaAsignadaCards();
                updateAnticipoSocioSelector();
            };
            const guardarSocios = (socios) => localStorage.setItem('socios', JSON.stringify(socios));
            const agregarSocioCard = (socio, index) => {
                const socioCard = document.createElement('div');
                socioCard.className = 'socio-card';
                socioCard.dataset.index = index;
                socioCard.dataset.type = 'socio';
                let htmlContent = `<h3>${socio.nombre} ${socio.apellido}</h3><p><strong>Ingreso:</strong> ${formatDate(socio.fechaIngreso)}</p><p><strong>Área:</strong> ${socio.area}</p><p><strong>Contrato:</strong> ${socio.tipoContrato}</p>`;
                if (socio.tipoContrato === 'Planta') {
                    htmlContent += `<p><strong>Puntos:</strong> ${socio.puntosPropina}</p>`;
                } else {
                    htmlContent += `<p><strong>Puntos Antigüedad Base:</strong> ${parseFloat(socio.puntosAntiguedadBase || 0).toFixed(2)}</p><p><strong>Días Trabajados:</strong> <span class="dias-trabajados-display">${socio.diasTrabajados.length}</span></p><p><strong>Monto Asignable:</strong> <span class="monto-asignable-display">$${formatNumber(socio.montoAsignablePartTime || 0)}</span></p><p><strong>Puntos Part-Time Asignados:</strong> <span class="puntos-part-time-display">${parseFloat(socio.puntosPropinaPartTime || 0).toFixed(2)}</span></p><div class="part-time-actions"><button class="calendar-btn" data-index="${index}">Registrar Días Trabajados</button><button class="calculate-part-time-points-btn" data-index="${index}">Calcular Puntos Part-Time</button></div>`;
                }
                htmlContent += `<div class="delete-button-wrapper"><button class="delete-btn" data-index="${index}" data-type="socio">Borrar</button></div>`;
                socioCard.innerHTML = htmlContent;
                (socio.tipoContrato === 'Planta' ? sociosPlantaContainer : sociosPartTimeContainer).appendChild(socioCard);
                socioCard.querySelector('.delete-btn').addEventListener('click', e => { e.stopPropagation(); if (confirm(`¿Borrar a ${socio.nombre} ${socio.apellido}?`)) eliminarItem('socio', index); });
                socioCard.addEventListener('click', e => { if (!e.target.closest('.part-time-actions button') && !e.target.classList.contains('delete-btn')) abrirModalEdicion('socio', index); });
                if (socio.tipoContrato === 'Part-Time') {
                    socioCard.querySelector('.calendar-btn').addEventListener('click', e => { e.stopPropagation(); abrirCalendarModal(index); });
                    socioCard.querySelector('.calculate-part-time-points-btn').addEventListener('click', e => { e.stopPropagation(); abrirPartTimePointsModal(index); });
                }
            };
            const agregarSocioDistribucionCard = (socio, index) => {
                const socioCard = document.createElement('div');
                socioCard.className = `socio-distribucion-card ${socio.tipoContrato === 'Part-Time' ? 'part-time' : ''}`;
                socioCard.dataset.index = index;
                socioCard.dataset.type = 'socio';
                let puntosAntiguedadDisplay = socio.tipoContrato === 'Planta' ? socio.puntosPropina : parseFloat(socio.puntosAntiguedadBase || 0).toFixed(2);
                let puntosCalculadosPartTimeDisplay = socio.tipoContrato === 'Part-Time' ? `<p class="puntos-calculados-pt"><strong>Puntos Calculados:</strong> ${parseFloat(socio.puntosPropinaPartTime || 0).toFixed(2)}</p>` : '';
                const propinaAsignada = parseFloat(socio.propinaAsignada || 0);
                const totalAnticiposSocio = (socio.anticipos || []).reduce((sum, ant) => sum + ant.cantidad, 0);
                const saldoDisponible = propinaAsignada - totalAnticiposSocio;
                socioCard.innerHTML = `<h3>${socio.nombre} ${socio.apellido}</h3><p><strong>Área:</strong> ${socio.area}</p><p><strong>Contrato:</strong> ${socio.tipoContrato}</p><p class="puntos"><strong>Puntos:</strong> ${puntosAntiguedadDisplay}</p>${puntosCalculadosPartTimeDisplay}<p class="propina-asignada">Propina Asignada: $${formatNumber(propinaAsignada)}</p><p class="saldo-disponible ${saldoDisponible < 0 ? 'negative' : ''}">Saldo Disponible: $${formatNumber(saldoDisponible)}</p>`;
                (socio.tipoContrato === 'Planta' ? distribucionPlantaContainer : distribucionPartTimeContainer).appendChild(socioCard);
                socioCard.addEventListener('click', () => displaySocioAnticiposHistoryModal(index));
            };
            const groupMontosByDate = (montos) => {
                const grouped = new Map();
                montos.forEach((monto, originalIndex) => {
                    if (!grouped.has(monto.fecha)) grouped.set(monto.fecha, { date: monto.fecha, total: 0, entries: [] });
                    const group = grouped.get(monto.fecha);
                    group.entries.push({ ...monto, originalIndex });
                    group.total += monto.cantidad;
                });
                return Array.from(grouped.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
            };
            const updateTotalGeneralPropinaBruta = (montos) => {
                const total = montos.reduce((sum, monto) => sum + monto.cantidad, 0);
                const formattedTotal = `$${formatNumber(total)}`;
                if (totalGeneralMontosRegistro) totalGeneralMontosRegistro.textContent = `Total General de Propina: ${formattedTotal}`;
                if (totalGeneralMontosDisplay) totalGeneralMontosDisplay.textContent = `Total General de Propina: ${formattedTotal}`;
                if (totalGeneralPropinaBrutaDistribucion) totalGeneralPropinaBrutaDistribucion.textContent = `Total General de Propina (Bruta): ${formattedTotal}`;
                return total;
            };
            const updateDailyTotalsModalContent = (groupedMontos) => {
                dailyTotalsList.innerHTML = '';
                if (groupedMontos.length === 0) {
                    dailyTotalsList.innerHTML = '<p style="text-align: center;">No hay montos diarios registrados.</p>';
                    return;
                }
                groupedMontos.forEach(group => {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${formatDate(group.date)}:</strong> <span>$${formatNumber(group.total)}</span>`;
                    dailyTotalsList.appendChild(p);
                });
            };
            const cargarMontos = () => {
                const montos = JSON.parse(localStorage.getItem('montos')) || [];
                const groupedMontos = groupMontosByDate(montos);
                montosRegistradosContainer.innerHTML = '';
                groupedMontos.forEach(group => agregarMontoCard(group));
                updateTotalGeneralPropinaBruta(montos);
                updateDailyTotalsModalContent(groupedMontos);
                guardarMontos(montos);
                updateGeneralTotals();
            };
            const guardarMontos = (montos) => localStorage.setItem('montos', JSON.stringify(montos));
            const agregarMontoCard = (groupedMonto) => {
                const montoCard = document.createElement('div');
                montoCard.className = 'monto-card';
                let entriesHtml = groupedMonto.entries.map(entry => `<div class="monto-entry-item" data-original-index="${entry.originalIndex}"><span>${entry.area}: $${formatNumber(entry.cantidad)}</span><button class="delete-btn" data-index="${entry.originalIndex}" data-type="monto">Borrar</button></div>`).join('');
                montoCard.innerHTML = `<h3>Monto del ${formatDate(groupedMonto.date)}</h3>${entriesHtml}<p class="date-total">Total Diario: $${formatNumber(groupedMonto.total)}</p>`;
                montosRegistradosContainer.appendChild(montoCard);
                montoCard.querySelectorAll('.monto-entry-item .delete-btn').forEach(button => {
                    button.addEventListener('click', e => {
                        e.stopPropagation();
                        const indexToDelete = parseInt(button.dataset.index);
                        const montos = JSON.parse(localStorage.getItem('montos'));
                        if (confirm(`¿Borrar la entrada de ${montos[indexToDelete].area}: $${formatNumber(montos[indexToDelete].cantidad)} del ${formatDate(montos[indexToDelete].fecha)}?`)) {
                            eliminarItem('monto', indexToDelete);
                        }
                    });
                });
                montoCard.querySelectorAll('.monto-entry-item').forEach(itemDiv => {
                    itemDiv.addEventListener('click', () => abrirModalEdicion('monto', parseInt(itemDiv.dataset.originalIndex)));
                });
            };
            const setupNumberInputFormatting = (input) => {
                input.addEventListener('input', e => {
                    const numberValue = parseInt(e.target.value.replace(/\./g, ''));
                    if (!isNaN(numberValue)) e.target.value = formatNumber(numberValue);
                });
                input.addEventListener('focus', e => { e.target.value = e.target.value.replace(/\./g, ''); });
                input.addEventListener('blur', e => {
                    const numberValue = parseInt(e.target.value.replace(/\./g, ''));
                    if (!isNaN(numberValue)) e.target.value = formatNumber(numberValue);
                });
            };
            [montoCantidadInput, anticipoCantidadInput, editMontoCantidadInput, editAnticipoCantidadInput, divisorPuntoPlantaInputEdit].forEach(setupNumberInputFormatting);
            const calcularTotalAnticiposGlobal = () => {
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                const total = socios.reduce((sum, socio) => sum + (socio.anticipos || []).reduce((subSum, ant) => subSum + ant.cantidad, 0), 0);
                totalGeneralAnticipos.textContent = `Total General de Anticipos: $${formatNumber(total)}`;
                return total;
            };
            const updateAnticipoSocioSelector = () => {
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                sociosAnticipoList.innerHTML = '';
                socios.forEach((socio, index) => {
                    const option = document.createElement('option');
                    option.value = `${socio.nombre} ${socio.apellido}`;
                    option.dataset.index = index;
                    sociosAnticipoList.appendChild(option);
                });
            };
            anticipoSocioInput.addEventListener('input', () => {
                const selectedOption = Array.from(sociosAnticipoList.options).find(option => option.value === anticipoSocioInput.value);
                if (selectedOption) {
                    anticipoSocioId.value = selectedOption.dataset.index;
                    displayAnticipoSocioInfo(parseInt(selectedOption.dataset.index));
                } else {
                    anticipoSocioId.value = '';
                    anticipoSocioInfoContainer.style.display = 'none';
                }
            });
            const displayAnticipoSocioInfo = (socioIndex) => {
                const socio = (JSON.parse(localStorage.getItem('socios')) || [])[socioIndex];
                if (!socio) {
                    anticipoSocioInfoContainer.style.display = 'none';
                    return;
                }
                const propinaAsignada = socio.propinaAsignada || 0;
                infoPropinaAsignada.textContent = `$${formatNumber(propinaAsignada)}`;
                const totalAnticiposSocio = (socio.anticipos || []).reduce((sum, ant) => sum + ant.cantidad, 0);
                infoAnticiposAnteriores.textContent = `$${formatNumber(totalAnticiposSocio)}`;
                const saldoDisponible = propinaAsignada - totalAnticiposSocio;
                infoSaldoDisponible.textContent = `$${formatNumber(saldoDisponible)}`;
                infoSaldoDisponible.classList.toggle('negative', saldoDisponible < 0);
                anticipoHistoryDisplay.innerHTML = '<h4>Historial de Anticipos</h4>';
                if (socio.anticipos && socio.anticipos.length > 0) {
                    [...socio.anticipos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(anticipo => {
                        const originalIndex = socio.anticipos.findIndex(a => a.fecha === anticipo.fecha && a.cantidad === anticipo.cantidad);
                        const historyItem = document.createElement('div');
                        historyItem.className = 'anticipo-history-item';
                        historyItem.innerHTML = `<span>${formatDate(anticipo.fecha)}: $${formatNumber(anticipo.cantidad)}</span><button class="delete-btn" data-socio-index="${socioIndex}" data-anticipo-index="${originalIndex}" data-type="anticipo">Borrar</button>`;
                        historyItem.addEventListener('click', e => { if (!e.target.classList.contains('delete-btn')) abrirModalEdicion('anticipo', originalIndex, socioIndex); });
                        anticipoHistoryDisplay.appendChild(historyItem);
                    });
                } else {
                    anticipoHistoryDisplay.innerHTML += '<p style="text-align: center;">No hay anticipos previos.</p>';
                }
                anticipoSocioInfoContainer.style.display = 'block';
            };
            const updateGeneralTotals = () => {
                const montos = JSON.parse(localStorage.getItem('montos')) || [];
                updateTotalGeneralPropinaBruta(montos);
                calcularTotalAnticiposGlobal();
                cargarPuntoPlantaDisplay();
                recalcularMontosAsignablesPartTime();
                updateBalanceReport();
            };
            const updateBalanceReport = () => {
                const totalPropinaBruta = (JSON.parse(localStorage.getItem('montos')) || []).reduce((sum, monto) => sum + monto.cantidad, 0);
                const totalAnticipos = (JSON.parse(localStorage.getItem('socios')) || []).reduce((sum, socio) => sum + (socio.anticipos || []).reduce((subSum, ant) => subSum + ant.cantidad, 0), 0);
                const saldoDisponible = totalPropinaBruta - totalAnticipos;
                balancePropinaBruta.textContent = `$${formatNumber(totalPropinaBruta)}`;
                balanceAnticipos.textContent = `$${formatNumber(totalAnticipos)}`;
                balanceSaldo.textContent = `$${formatNumber(saldoDisponible)}`;
                balanceSaldo.classList.remove('negative', 'positive');
                if (saldoDisponible < 0) balanceSaldo.classList.add('negative');
                else if (saldoDisponible > 0) balanceSaldo.classList.add('positive');
            };
            const eliminarItem = (type, index, socioIndex = -1, modalToClose = null) => {
                let items, storageKey, reloadFn;
                if (type === 'socio') {
                    items = JSON.parse(localStorage.getItem('socios'));
                    if (confirm(`¿Borrar a ${items[index].nombre} ${items[index].apellido}? Esta acción eliminará también sus anticipos.`)) {
                        items.splice(index, 1);
                        localStorage.setItem('socios', JSON.stringify(items));
                        cargarSocios();
                    }
                } else if (type === 'monto') {
                    items = JSON.parse(localStorage.getItem('montos'));
                    if (confirm(`¿Borrar la entrada de ${items[index].area}: $${formatNumber(items[index].cantidad)} del ${formatDate(items[index].fecha)}?`)) {
                        items.splice(index, 1);
                        localStorage.setItem('montos', JSON.stringify(items));
                        cargarMontos();
                    }
                } else if (type === 'anticipo') {
                    items = JSON.parse(localStorage.getItem('socios'));
                    if (confirm(`¿Borrar el anticipo de $${formatNumber(items[socioIndex].anticipos[index].cantidad)} del ${formatDate(items[socioIndex].anticipos[index].fecha)} para ${items[socioIndex].nombre}?`)) {
                        items[socioIndex].anticipos.splice(index, 1);
                        localStorage.setItem('socios', JSON.stringify(items));
                        cargarSocios();
                        if (socioIndex !== -1 && items[socioIndex]) displayAnticipoSocioInfo(socioIndex);
                        else { anticipoSocioInput.value = ''; anticipoSocioId.value = ''; anticipoSocioInfoContainer.style.display = 'none'; }
                        if (modalToClose) cerrarModal(modalToClose);
                    }
                }
            };
            const abrirModalEdicion = (type, index, parentIndex = -1) => {
                editItemType.value = type;
                editItemIndex.value = index;
                editFieldsSocio.style.display = 'none';
                editFieldsMonto.style.display = 'none';
                editFieldsAnticipo.style.display = 'none';
                [...editFieldsSocio.querySelectorAll('input, select'), ...editFieldsMonto.querySelectorAll('input, select'), ...editFieldsAnticipo.querySelectorAll('input, select')].forEach(input => input.required = false);
                if (type === 'socio') {
                    editModalTitle.textContent = 'Editar Socio';
                    editFieldsSocio.style.display = 'block';
                    const socio = JSON.parse(localStorage.getItem('socios'))[index];
                    if (socio) {
                        editNombre.value = socio.nombre; editApellido.value = socio.apellido; editFechaIngreso.value = socio.fechaIngreso; editArea.value = socio.area; editTipoContrato.value = socio.tipoContrato;
                        [...editFieldsSocio.querySelectorAll('input, select')].forEach(input => input.required = true);
                    }
                } else if (type === 'monto') {
                    editModalTitle.textContent = 'Editar Monto';
                    editFieldsMonto.style.display = 'block';
                    const monto = JSON.parse(localStorage.getItem('montos'))[index];
                    if (monto) {
                        editMontoFecha.value = monto.fecha; editMontoArea.value = monto.area; editMontoCantidad.value = formatNumber(monto.cantidad);
                        [...editFieldsMonto.querySelectorAll('input, select')].forEach(input => input.required = true);
                    }
                } else if (type === 'anticipo') {
                    editModalTitle.textContent = 'Editar Anticipo';
                    editFieldsAnticipo.style.display = 'block';
                    const anticipo = JSON.parse(localStorage.getItem('socios'))[parentIndex].anticipos[index];
                    if (anticipo) {
                        editAnticipoFecha.value = anticipo.fecha; editAnticipoCantidad.value = formatNumber(anticipo.cantidad);
                        editItemIndex.dataset.parentIndex = parentIndex;
                        [...editFieldsAnticipo.querySelectorAll('input, select')].forEach(input => input.required = true);
                    } else return;
                }
                editModal.style.display = 'flex';
            };
            const cerrarModal = (modal) => modal.style.display = 'none';
            document.querySelectorAll('.close-button').forEach(button => button.addEventListener('click', e => cerrarModal(document.getElementById(e.target.dataset.modalClose || e.target.closest('.modal').id))));
            window.addEventListener('click', e => { if (e.target.classList.contains('modal')) cerrarModal(e.target); });
            editFormUniversal.addEventListener('submit', e => {
                e.preventDefault();
                const type = editItemType.value, index = parseInt(editItemIndex.value);
                let items, storageKey, reloadFn, itemActualizado;
                if (type === 'socio') {
                    items = JSON.parse(localStorage.getItem('socios'));
                    itemActualizado = { ...items[index], nombre: editNombre.value, apellido: editApellido.value, fechaIngreso: editFechaIngreso.value, area: editArea.value, tipoContrato: editTipoContrato.value };
                    const puntosCalc = calcularPuntosPropinaBase(itemActualizado.fechaIngreso, itemActualizado.area, itemActualizado.tipoContrato);
                    if (itemActualizado.tipoContrato === 'Planta') {
                        itemActualizado.puntosPropina = puntosCalc.puntosConTope;
                        delete itemActualizado.diasTrabajados; delete itemActualizado.montoAsignablePartTime; delete itemActualizado.puntosPropinaPartTime; delete itemActualizado.puntosAntiguedadBase;
                    } else {
                        itemActualizado.diasTrabajados = itemActualizado.diasTrabajados || [];
                        itemActualizado.puntosAntiguedadBase = puntosCalc.puntosSinTope;
                        itemActualizado.montoAsignablePartTime = calcularMontoAsignablePartTime(itemActualizado.diasTrabajados);
                        itemActualizado.puntosPropinaPartTime = itemActualizado.puntosPropinaPartTime || 0;
                        delete itemActualizado.puntosPropina;
                    }
                    items[index] = itemActualizado;
                    localStorage.setItem('socios', JSON.stringify(items));
                    cargarSocios();
                } else if (type === 'monto') {
                    items = JSON.parse(localStorage.getItem('montos'));
                    items[index] = { fecha: editMontoFecha.value, area: editMontoArea.value, cantidad: parseNumber(editMontoCantidad.value) };
                    localStorage.setItem('montos', JSON.stringify(items));
                    cargarMontos();
                } else if (type === 'anticipo') {
                    items = JSON.parse(localStorage.getItem('socios'));
                    const socioIndex = parseInt(editItemIndex.dataset.parentIndex);
                    items[socioIndex].anticipos[index] = { fecha: editAnticipoFecha.value, cantidad: parseNumber(editAnticipoCantidad.value) };
                    localStorage.setItem('socios', JSON.stringify(items));
                    cargarSocios();
                    displayAnticipoSocioInfo(socioIndex);
                    displaySocioAnticiposHistoryModal(socioIndex);
                }
                cerrarModal(editModal);
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} actualizado!`);
            });
            registroSocioForm.addEventListener('submit', e => {
                e.preventDefault();
                const nuevoSocio = { nombre: nombre.value, apellido: apellido.value, fechaIngreso: fechaIngreso.value, area: area.value, tipoContrato: tipoContrato.value };
                const puntosCalc = calcularPuntosPropinaBase(nuevoSocio.fechaIngreso, nuevoSocio.area, nuevoSocio.tipoContrato);
                if (nuevoSocio.tipoContrato === 'Planta') nuevoSocio.puntosPropina = puntosCalc.puntosConTope;
                else { nuevoSocio.diasTrabajados = []; nuevoSocio.montoAsignablePartTime = 0; nuevoSocio.puntosAntiguedadBase = puntosCalc.puntosSinTope; nuevoSocio.puntosPropinaPartTime = 0; }
                nuevoSocio.anticipos = [];
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                socios.push(nuevoSocio);
                guardarSocios(socios);
                cargarSocios();
                registroSocioForm.reset();
                alert('Socio registrado!');
            });
            registroMontoForm.addEventListener('submit', e => {
                e.preventDefault();
                const nuevoMonto = { fecha: montoFecha.value, area: montoArea.value, cantidad: parseNumber(montoCantidadInput.value) };
                const montos = JSON.parse(localStorage.getItem('montos')) || [];
                montos.push(nuevoMonto);
                guardarMontos(montos);
                cargarMontos();
                recalcularMontosAsignablesPartTime();
                registroMontoForm.reset();
                alert('Monto registrado!');
            });
            registroAnticipoForm.addEventListener('submit', e => {
                e.preventDefault();
                const socioIndex = parseInt(anticipoSocioId.value);
                if (isNaN(socioIndex) || socioIndex < 0) return alert('Por favor, seleccione un socio válido.');
                const socios = JSON.parse(localStorage.getItem('socios'));
                const socio = socios[socioIndex];
                if (!socio) return alert('Socio no encontrado.');
                const rawAnticipoCantidad = parseNumber(anticipoCantidadInput.value);
                const currentSaldoDisponible = parseNumber(infoSaldoDisponible.textContent.replace('$', ''));
                if (rawAnticipoCantidad > currentSaldoDisponible) return alert(`El monto del anticipo ($${formatNumber(rawAnticipoCantidad)}) excede el saldo disponible ($${formatNumber(currentSaldoDisponible)}).`);
                if (!socio.anticipos) socio.anticipos = [];
                socio.anticipos.push({ fecha: anticipoFecha.value, cantidad: rawAnticipoCantidad });
                guardarSocios(socios);
                displayAnticipoSocioInfo(socioIndex);
                calcularTotalAnticiposGlobal();
                updatePropinaAsignadaCards();
                updateBalanceReport();
                registroAnticipoForm.reset();
                anticipoSocioInput.value = '';
                anticipoSocioInfoContainer.style.display = 'none';
                alert('Anticipo registrado!');
            });
            document.querySelectorAll('.show-daily-totals-btn').forEach(btn => btn.addEventListener('click', () => dailyTotalsModal.style.display = 'flex'));
            document.querySelectorAll('.show-punto-planta-btn').forEach(btn => btn.addEventListener('click', () => {
                const totalPropinaBruta = (JSON.parse(localStorage.getItem('montos')) || []).reduce((sum, monto) => sum + monto.cantidad, 0);
                const totalAnticipos = calcularTotalAnticiposGlobal();
                const propinaNeta = totalPropinaBruta - totalAnticipos;
                let totalPuntos = (JSON.parse(localStorage.getItem('socios')) || []).filter(s => s.tipoContrato === 'Planta').reduce((sum, s) => sum + s.puntosPropina, 0);
                propinaBrutaModal.textContent = `$${formatNumber(totalPropinaBruta)}`;
                retirosModal.textContent = `$${formatNumber(totalAnticipos)}`;
                propinaNetaModal.textContent = `$${formatNumber(propinaNeta)}`;
                totalPuntosSociosModal.textContent = totalPuntos.toFixed(2);
                const lastPuntoPlanta = parseFloat(localStorage.getItem('lastPuntoPlantaValue')) || 0;
                divisorPuntoPlantaInput.value = '1';
                puntoPlantaValor.textContent = `Punto-Planta: $${lastPuntoPlanta.toLocaleString('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                puntoPlantaModal.style.display = 'flex';
            }));
            calcularPuntoPlantaInternoBtn.addEventListener('click', () => {
                const totalPropinaBruta = (JSON.parse(localStorage.getItem('montos')) || []).reduce((sum, monto) => sum + monto.cantidad, 0);
                const divisor = parseNumber(divisorPuntoPlantaInput.value);
                if (isNaN(divisor) || divisor <= 0) return alert("Por favor, ingrese un divisor válido.");
                const puntoPlanta = totalPropinaBruta / divisor;
                puntoPlantaValor.textContent = `Punto-Planta: $${parseFloat(puntoPlanta).toLocaleString('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                localStorage.setItem('lastPuntoPlantaValue', puntoPlanta.toFixed(2));
                cargarPuntoPlantaDisplay();
                updatePropinaAsignadaCards();
                const currentSocioAnticipoIndex = parseInt(anticipoSocioId.value);
                if (!isNaN(currentSocioAnticipoIndex) && currentSocioAnticipoIndex >= 0) displayAnticipoSocioInfo(currentSocioAnticipoIndex);
            });
            const updatePropinaAsignadaCards = () => {
                const puntoPlanta = parseFloat(localStorage.getItem('lastPuntoPlantaValue')) || 0;
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                document.querySelectorAll('.socio-distribucion-card').forEach(card => {
                    const socio = socios[parseInt(card.dataset.index)];
                    if (socio) {
                        let propinaAsignada = socio.tipoContrato === 'Planta' ? socio.puntosPropina * puntoPlanta : (socio.puntosAntiguedadBase || 0) * (socio.puntosPropinaPartTime || 0);
                        socio.propinaAsignada = propinaAsignada;
                        const totalAnticiposSocio = (socio.anticipos || []).reduce((sum, ant) => sum + ant.cantidad, 0);
                        const saldoDisponible = propinaAsignada - totalAnticiposSocio;
                        card.querySelector('.propina-asignada').textContent = `Propina Asignada: $${formatNumber(propinaAsignada)}`;
                        const saldoEl = card.querySelector('.saldo-disponible');
                        saldoEl.textContent = `Saldo Disponible: $${formatNumber(saldoDisponible)}`;
                        saldoEl.classList.toggle('negative', saldoDisponible < 0);
                    }
                });
                guardarSocios(socios);
            };
            const cargarPuntoPlantaDisplay = () => {
                const lastPuntoPlanta = parseFloat(localStorage.getItem('lastPuntoPlantaValue')) || 0;
                puntoPlantaDisplay.textContent = `Último Punto-Planta: $${lastPuntoPlanta.toLocaleString('es-CL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };
            const abrirCalendarModal = (socioIndex) => {
                currentSocioIndexCalendar = socioIndex;
                const socio = JSON.parse(localStorage.getItem('socios'))[socioIndex];
                if (!socio || socio.tipoContrato !== 'Part-Time') return;
                calendarModalTitle.textContent = `Días Trabajados de ${socio.nombre} ${socio.apellido}`;
                if (!flatpickrInstance) {
                    flatpickrInstance = flatpickr(flatpickrInput, {
                        mode: "multiple", dateFormat: "Y-m-d", locale: "es", inline: false,
                        onChange: (selectedDates) => {
                            const socios = JSON.parse(localStorage.getItem('socios'));
                            const dias = selectedDates.map(d => flatpickr.formatDate(d, "Y-m-d"));
                            socios[currentSocioIndexCalendar].diasTrabajados = dias;
                            socios[currentSocioIndexCalendar].montoAsignablePartTime = calcularMontoAsignablePartTime(dias);
                            guardarSocios(socios);
                            cargarSocios();
                            selectedDaysCountSpan.textContent = selectedDates.length;
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            const socioOnOpen = JSON.parse(localStorage.getItem('socios'))[currentSocioIndexCalendar];
                            instance.setDate(socioOnOpen.diasTrabajados || [], true);
                            selectedDaysCountSpan.textContent = socioOnOpen.diasTrabajados ? socioOnOpen.diasTrabajados.length : 0;
                        }
                    });
                }
                flatpickrInstance.open();
                calendarModal.style.display = 'flex';
            };
            const abrirPartTimePointsModal = (socioIndex) => {
                currentSocioIndexPartTimePoints = socioIndex;
                const socio = JSON.parse(localStorage.getItem('socios'))[socioIndex];
                if (!socio || socio.tipoContrato !== 'Part-Time') return;
                partTimePointsModalTitle.textContent = `Calcular Puntos de ${socio.nombre} ${socio.apellido}`;
                partTimeModalBasePoints.textContent = parseFloat(socio.puntosAntiguedadBase || 0).toFixed(2);
                partTimeModalAssignableAmount.textContent = `$${formatNumber(socio.montoAsignablePartTime || 0)}`;
                partTimeMultiplicadorInput.value = (socio.puntosPropinaPartTime > 0 && (socio.puntosAntiguedadBase || 0) > 0) ? (socio.puntosPropinaPartTime / socio.puntosAntiguedadBase).toFixed(2) : '1';
                partTimePointsValue.textContent = `Puntos: ${parseFloat(socio.puntosPropinaPartTime || 0).toFixed(2)}`;
                partTimePointsModal.style.display = 'flex';
            };
            calcularPartTimePointsInternoBtn.addEventListener('click', () => {
                if (currentSocioIndexPartTimePoints === -1) return;
                const socios = JSON.parse(localStorage.getItem('socios'));
                const socio = socios[currentSocioIndexPartTimePoints];
                const multiplicador = parseNumber(partTimeMultiplicadorInput.value);
                if (isNaN(multiplicador) || multiplicador <= 0) return alert("Por favor, ingrese un multiplicador válido.");
                const nuevosPuntos = (socio.montoAsignablePartTime || 0) / multiplicador;
                socio.puntosPropinaPartTime = nuevosPuntos;
                partTimePointsValue.textContent = `Puntos: ${parseFloat(nuevosPuntos).toFixed(2)}`;
                guardarSocios(socios);
                cargarSocios();
            });
            const recalcularMontosAsignablesPartTime = () => {
                const socios = JSON.parse(localStorage.getItem('socios')) || [];
                let modified = false;
                socios.forEach(socio => {
                    if (socio.tipoContrato === 'Part-Time') {
                        const nuevoMonto = calcularMontoAsignablePartTime(socio.diasTrabajados || []);
                        if (socio.montoAsignablePartTime !== nuevoMonto) {
                            socio.montoAsignablePartTime = nuevoMonto;
                            modified = true;
                        }
                    }
                });
                if (modified) {
                    guardarSocios(socios);
                    cargarSocios();
                }
            };
            const displaySocioAnticiposHistoryModal = (socioIndex) => {
                const socio = JSON.parse(localStorage.getItem('socios'))[socioIndex];
                if (!socio) return;
                socioAnticiposHistoryModalTitle.textContent = `Historial de Anticipos de ${socio.nombre} ${socio.apellido}`;
                const propinaAsignada = parseFloat(socio.propinaAsignada || 0);
                const totalAnticipos = (socio.anticipos || []).reduce((sum, ant) => sum + ant.cantidad, 0);
                const saldo = propinaAsignada - totalAnticipos;
                modalSocioPropinaAsignada.textContent = `$${formatNumber(propinaAsignada)}`;
                modalSocioTotalAnticipos.textContent = `$${formatNumber(totalAnticipos)}`;
                modalSocioSaldo.textContent = `$${formatNumber(saldo)}`;
                modalSocioSaldo.classList.toggle('negative', saldo < 0);
                modalSocioAnticiposList.innerHTML = '<h4>Detalle de Anticipos</h4>';
                if (socio.anticipos && socio.anticipos.length > 0) {
                    [...socio.anticipos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(anticipo => {
                        const originalIndex = socio.anticipos.findIndex(ant => ant.fecha === anticipo.fecha && ant.cantidad === anticipo.cantidad);
                        const item = document.createElement('div');
                        item.className = 'anticipo-history-item';
                        item.innerHTML = `<span>${formatDate(anticipo.fecha)}: $${formatNumber(anticipo.cantidad)}</span><button class="delete-btn" data-socio-index="${socioIndex}" data-anticipo-index="${originalIndex}" data-type="anticipo">Borrar</button>`;
                        item.querySelector('.delete-btn').addEventListener('click', e => { e.stopPropagation(); if (confirm(`¿Borrar anticipo?`)) eliminarItem('anticipo', originalIndex, socioIndex, socioAnticiposHistoryModal); });
                        modalSocioAnticiposList.appendChild(item);
                    });
                } else {
                    modalSocioAnticiposList.innerHTML += '<p style="text-align: center;">No hay anticipos registrados.</p>';
                }
                socioAnticiposHistoryModal.style.display = 'flex';
            };
            exportDataBtn.addEventListener('click', () => {
                const data = { socios: JSON.parse(localStorage.getItem('socios')) || [], montos: JSON.parse(localStorage.getItem('montos')) || [], lastPuntoPlantaValue: localStorage.getItem('lastPuntoPlantaValue') || '0' };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `backup_propina_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });
            importFileInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        const data = JSON.parse(re.target.result);
                        if (data && data.socios && data.montos && confirm("¿Importar datos? Se sobrescribirán los actuales.")) {
                            localStorage.setItem('socios', JSON.stringify(data.socios));
                            localStorage.setItem('montos', JSON.stringify(data.montos));
                            localStorage.setItem('lastPuntoPlantaValue', data.lastPuntoPlantaValue || '0');
                            alert('Datos importados. La página se recargará.');
                            window.location.reload();
                        } else alert('El archivo no tiene el formato correcto.');
                    } catch (err) { alert('Error al procesar el archivo.'); }
                };
                reader.readAsText(file);
            });
            socioSearchInput.addEventListener('input', e => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.socio-distribucion-card').forEach(card => {
                    const nombre = card.querySelector('h3').textContent.toLowerCase();
                    const area = card.querySelector('p strong').nextSibling.textContent.toLowerCase();
                    card.style.display = (nombre.includes(searchTerm) || area.includes(searchTerm)) ? 'block' : 'none';
                });
            });
            deleteAllDataBtn.addEventListener('click', () => {
                if (confirm("ADVERTENCIA: ¿Seguro que quieres borrar TODOS los montos y anticipos?")) {
                    if (prompt("Escribe 'BORRAR' para confirmar:") === "BORRAR") {
                        localStorage.removeItem('montos');
                        let socios = JSON.parse(localStorage.getItem('socios')) || [];
                        socios.forEach(s => { s.anticipos = []; s.propinaAsignada = 0; });
                        localStorage.setItem('socios', JSON.stringify(socios));
                        localStorage.removeItem('lastPuntoPlantaValue');
                        alert("Montos y anticipos eliminados.");
                        window.location.reload();
                    } else alert("Acción cancelada.");
                } else alert("Acción cancelada.");
            });
            cargarSocios();
            cargarMontos();
            updateGeneralTotals();
        });
    </script>
</body>
</html>


